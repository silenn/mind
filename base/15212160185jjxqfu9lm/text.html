<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000; background-color:#ffffff;">В системе FreeRTOS каждый поток выполнения называется 'задачей' (task). Нет абсолютного согласия в терминологии по компонентам внутри встраиваемых систем, но наверное предпочтительнее использовать вместо термина 'поток' (thread) термин 'задача' (task), поскольку thread (поток) может иметь более специфичное значение в зависимости от внешних ранее приобретенных знаний.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; font-weight:600; color:#000000; background-color:#ffffff;">Функции задачи</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000; background-color:#ffffff;">Задачи реализованы как функции на языке C. Есть только одна особенность в прототипе такой функции - она должна возвращать void и принимать в качестве параметра указатель на void</span>.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:13px; color:#0000ff; background-color:#ffffff;">void</span><span style=" font-family:'Courier New'; font-size:13px; color:#000000; background-color:#ffffff;"> ATaskFunction( </span><span style=" font-family:'Courier New'; font-size:13px; color:#0000ff; background-color:#ffffff;">void</span><span style=" font-family:'Courier New'; font-size:13px; color:#000000; background-color:#ffffff;"> *pvParameters );</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000; background-color:#ffffff;">Каждая задача - это маленькая программа со своими собственными правами. Она имеет точку входа, нормально выполняет свой бесконечный цикл, из которого никогда не делает выход. Структура типичной задачи показана в листинге 2.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000; background-color:#ffffff;">Задачи FreeRTOS не должны никоим образом делать возврат (выход) из своей функции - она не должна содержать оператор 'return', и выполнению не должно быть позволено доходить до конца функции. Если в функции больше нет надобности, вместо выхода из неё нужно явно удалить запущенную задачу. Это также демонстрируется в листинге 2.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000; background-color:#ffffff;">Один и тот же код функции может использоваться для запуска любого количества одинаковых задач - каждая созданная задача имеет индивидуальную среду выполнения с собственным стеком и собственной копией любых автоматических (стековых) переменных, определенных в теле задачи.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:11px; color:#0000ff; background-color:#ffffff;">void</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"> ATaskFunction( </span><span style=" font-family:'Courier New'; font-size:11px; color:#0000ff; background-color:#ffffff;">void</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:11px; color:#008000; background-color:#ffffff;">   /* Переменные могут быть определены точно так же, как и в обычной функции.</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:11px; color:#008000; background-color:#ffffff;">      Каждый экземпляр созданной по этой функции задачи будет иметь собственную копию</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:11px; color:#008000; background-color:#ffffff;">      переменной iVariableExample. Это не верно, если переменная была продекларирована</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:11px; color:#008000; background-color:#ffffff;">      как статическая (static) – в этом случае будет сущесвовать только одна копия</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:11px; color:#008000; background-color:#ffffff;">      переменной, и она будет использоваться совместно всеми созданными экземплярами<br />      задачи. */</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:11px; color:#0000ff; background-color:#ffffff;">   int</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"> iVariableExample = 0;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:11px; color:#008000; background-color:#ffffff;">/* Задача должна быть нормально реализована как бесконечный цикл. */</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"><br />  </span><span style=" font-family:'Courier New'; font-size:11px; color:#0000ff; background-color:#ffffff;">for</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:11px; color:#008000; background-color:#ffffff;">/* Код, который реализует функционал задачи, должен быть помещен здесь. */</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"><br />  }<br /><br /></span><span style=" font-family:'Courier New'; font-size:11px; color:#008000; background-color:#ffffff;">   /* Код должен быть организован так, чтобы в случае выхода (break) из указанного</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:11px; color:#008000; background-color:#ffffff;">      выше бесконечного цикла задачи, задача должна быть удалена ПРЕЖДЕ чем</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:11px; color:#008000; background-color:#ffffff;">      управление достигнет конца этой функции. Параметр NULL, переданный<br />      vTaskDelete(), показывает, что должна быть удалена вызванная (эта, которая<br />      работает) задача. */</span><span style=" font-family:'Courier New'; font-size:11px; color:#000000; background-color:#ffffff;"><br />   vTaskDelete( NULL );<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-size:11px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000; background-color:#ffffff;">Листинг 2. Структура типичной функции задачи</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; font-weight:600; color:#000000; background-color:#ffffff;">Состояния задачи на верхнем уровне</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; font-weight:600; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000; background-color:#ffffff;">Приложение может состоять из множества задач. Если микроконтроллер, выполняющий приложение, имеет только одно ядро (так бывает в большинстве малых встраиваемых систем), то в каждый момент времени может выполняться только какая-то одна задача. Это означает, что любая задача может находиться в одном из двух возможных состояний - запущена (</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; font-weight:600; color:#000000;">Running</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;">) и не запущена (</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; font-weight:600; color:#000000;">Not Running</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;">). Пока мы примем такое упрощение, однако надо иметь в виду, что на самом деле состояние Not Running имеет несколько разновидностей - подсостояний (это мы рассмотрим далее).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000; background-color:#ffffff;">когда задача находится в состоянии Running, то процессор в настоящий момент выполняет её код. Когда задача находится в состоянии Not Running, то задача находится в бездействии, её текущий статус сохранен в готовности продолжить выполнение, как только шедулер примет решение перевести задачу в состояние Running. Когда задача продолжает выполнение, она начнет работу именно с той инструкции, где выполнение было прервано при выходе задачи из последнего состояния Running.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000; background-color:#ffffff;">О задаче, переходящей из состояния Not Running в состояние Running, говорят, что она &quot;подключилась&quot; (&quot;switched in&quot; или &quot;swapped in&quot;). И аналогично, о задаче, переходящей из состояния Running в состояние Not Running говорят, что она &quot;отключилась&quot; (&quot;switched out&quot; или &quot;swapped out&quot;). Шедулер FreeRTOS - всего лишь некая сущность, которая может включить (in) и выключить (out) задачу.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; font-weight:600; color:#000000; background-color:#ffffff;">Создание задач</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:11px; color:#000000;"><br /></p></body></html>