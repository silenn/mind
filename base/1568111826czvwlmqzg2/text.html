<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Georgia'; font-size:11pt; font-weight:400; font-style:normal;">
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td width="100%">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Проектирование стека и кучи в IAR </span></p></td>
<td width="100%">
<p align="right" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image15558.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;"> </span></p></td></tr></table>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p></td></tr>
<tr>
<td style=" vertical-align:top;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Понятия стека (stack) и кучи (heap) фундаментальны для встраиваемой системы. Их настройка очень важна для стабильной и надежной работы системы. Некорректное использование может привести к тому, что Ваше встраиваемое устройство на микроконтроллере будет глючить самым непредсказуемым образом. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Программист должен статически выбрать в памяти место расположения и размер как для стека, так и для кучи. Вычислить размер стека чаще всего очень трудно, за исключением совсем уж маленьких и простых встраиваемых систем, и недооценка использования стока может привести к серьезным ошибкам времени выполнения, которые бывает трудно найти. С другой стороны, переоценка места для стека означает бесполезную трату ценного ресурса памяти. Информация для самого худшего случая максимальной глубины стека очень полезна для большинства встраиваемых проектов, так как это значительно упрощает оценку, сколько места под стек нужно приложению. Переполнения памяти кучи происходят корректно, но такие случаи все равно неудобны, потому что очень мало встраиваемых приложений могут восстановить работоспособность в таких экстремальных условиях нехватки памяти.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">[</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Краткое введение в стек и кучу</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Описание в этой статье сосредоточено на разработке надежного стека и кучи: как минимизировать стек и кучу безопасным способом.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Настольные компьютерные системы (компьютеры PC) и встраиваемые системы одинаково страдают от общих ошибок в дизайне стека и кучи, однако полностью отличаются друг от друга в реализации многих других аспектов. Один пример различий в этих рабочих условиях - размер доступной памяти. Windows и Linux по умолчанию используют 1 и 8 мегабайт пространства под стек; этот размер даже может увеличиваться. Размер кучи ограничен только доступной физической памятью и/или размером файла подкачки. Встраиваемые системы, с другой стороны, имеют очень ограниченный размер по ресурсам памяти, особенно когда это память RAM. Несомненно здесь требуется минимизировать стек и кучу, чтобы уложиться в ограничения по памяти для этого рабочего окружения. Большинство малых встраиваемых систем не имеют механизма виртуальной памяти; выделения стека, кучи и глобальных данных (т. е. переменных, буферов TCP/IP, USB и т. д.) статические, и это происходит в момент сборки приложения.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Мы рассмотрим специальные проблемы, которые возникают во встраиваемых системах, не касаясь того, как защищать стек и кучу от специально направленных атак. Описание пока не касается разработки на десктоп-системах и мобильных устройствах (телефоны, смартфоны).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Превышение лимита</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Превышение пределов ограничений в реальной жизни может быть иногда полезным, но иногда может создать для Вас проблему. Превышение пределов в программировании, когда это происходит с выделением данных, однозначно приведет к проблеме. В счастливом случае проблема может возникнуть сразу или во время тестирования системы, но может также случиться и слишком поздно, когда продукт попал к тысячам пользователей или был развернут в удаленном окружении.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Переполнение выделенных данных может произойти в трех областях хранения данных; глобальные переменные (global), стек (stack) и куча (heap). Запись в массивы с превышением индекса или запись по адресу в указателе может привести к выходу за пределы памяти, выделенной для объекта (в таком случае могут быть испорчены другие важные данные). Некоторые попытки доступа к массиву могут быть проверены статическим анализом, например самим компилятором или чекером MISRA C: </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">int</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> array[</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">32</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">];</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">array[</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">35</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">] </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">0x1234</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Когда индекс вычисляется в выражении, статический анализ не сможет больше искать подобные проблемы. Обращения по указателям также сложны для трассировки статическим анализом: </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">int</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> malloc(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">32</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#008000;">sizeof</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">int</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)); </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">35</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">0x1234</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Долгое время методы перехвата ошибок переполнения объектов были доступны для десктоп-систем (можно назвать некоторые из них: Purify, Insure++, Valgrind). Эти средства встраивали в код приложения специальные проверки обращений к памяти во время выполнения программы. Это происходит ценой снижения скорости выполнения кода приложения и увеличения размера кода, так что такой метод не может быть полезным для малых встраиваемых систем.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Stack</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Стек это область памяти, где программа сохраняет, к примеру, следующие данные:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Локальные переменные<br />• Адреса возврата из подпрограмм<br />• Аргументы функции<br />• Временные ячейки памяти, используемые компилятором<br />• Контекст прерываний</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Время жизни переменных в стеке ограничено длительностью работы функции (или подпрограммы), которой они принадлежат. Как только функция выполнила возврат в код, который её вызвал, используемая ей память стека немедленно освобождается для последующих вызовов подпрограмм.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Память стека выделяется статически программистом в процессе разработки приложения. Стек обычно растет вниз (в сторону уменьшения адреса в памяти), и если область памяти, выделенная под стек, недостаточно велика, то выполняющийся код перезапишет область памяти, лежащую ниже стека, и произойдет переполнение стека (см. рис. 1).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image31138.png" style="vertical-align: top;" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Рис. 1. Ситуация переполнения стека.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Записываемая при переполнении стека область это то место, где находятся глобальные и статические переменные. Таким образом, недооценка места под стек может привести к серьезным ошибкам времени выполнения, таким как перезапись переменных, дикие указатели и испорченные адреса возврата. Все эти ошибки может быть трудны для обнаружения. С другой стороны, переоценка места под стек означает трату ресурсов оперативной памяти.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Мы рассмотрим некоторые методы для надежного вычисления требуемого размера стека и детектирования проблем, связанных со стеком.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Heap</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Куча это то место, где размещена подсистема динамического выделения памяти (не путайте в данном контексте динамическую память с DRAM и SDRAM!). Динамическая память и куча может во многих случаях быть необязательной для применения во встраиваемых системах (может рассматриваться как опция). Динамическая память делает возможным использование одной и той же памяти совместно разными частями программы (имеется в виду не одновременное использование). Когда один модуль больше не нуждается в своей выделенной памяти, он просто возвращает её в общий пул кучи, после чего она может повторно использоваться каким-то другим модулем. Операциями выделения и освобождения памяти заведует специальная библиотека управления динамической памяти, предоставляющая функции наподобие malloc, calloc, realloc и free [] на языке C. Язык C++ использует библиотеку динамической памяти в операторах new и delete. Кучу также могут использовать сторонние библиотеки кода и операционные системы реального времени (RTOS []). Обычно куча одна, но их может быть и несколько. Некоторые особо продвинутые библиотеки даже могут использовать свои функции для обслуживания динамической памяти. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Типичные примеры данных, которые размещаются в куче:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Объекты текущих данных<br />• Объекты C++, время жизни которых управляются операторами new/delete<br />• Контейнеры STL C++<br />• Исключения C++</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Вычисление размера кучи может быть как очень трудно, так и вовсе невозможно для больших систем - из-за динамического поведения приложения. Например, количество памяти в куче, которую может потребовать для себя веб-сервер, может зависеть от количества одновременных сетевых подключений. Кроме того, довольно мало инструментов поддержки измерения утилизации стека в мире встраиваемых приложений, но некоторые методы мы рассмотрим.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Важно поддерживать целостность кучи. Выделенное пространство данных типично сопровождается критичными данными по обслуживанию обработчика выделений памяти. Неправильное использование пространства выделяемых данных не только вводит риск повреждения других данных, то также может повредить служебные данные обработчика выделений памяти, что скорее всего приведет к полному краху приложения. Мы обсудим некоторые методы, помогающие проверить целостность кучи.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Другой аспект использования кучи в том, что производительность кода реального времени с данными в куче становится неопределенным. Время выделения памяти зависит от таких факторов, как предыдущие выделения и освобождения памяти, наличие в куче &quot;дырок&quot; и от эффективности уборщика мусора. Когда разработчик учитывает каждый цикл выполнения кода для обеспечения прогнозируемого поведения в реальном времени, интенсивные выделения/освобождения памяти могут стать недопустимыми.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Общие рекомендации в этой статье касаются в основном минимизации размера кучи в малых встраиваемых системах.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">[</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Разработка надежного стека</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="1_spoiler"></a><a href="javascript:void(0)"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">П</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">очему вычислить размер стека так сложно?</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="1-sp-body"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Е</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">сть много факторов, добавляющих сложности в вычислении максимального использования стека. Многие приложения сложны и реагируют на внешние события (event driven), в них есть сотни функция и множество прерываний. Есть вероятность, что функции обработки прерывания (ISR) могут запуститься в любой момент времени, и если разрешено вложение вызовов прерываний друг в друга, то ситуация становится еще более сложной для оценки. Это означает, что отсутствует легко сопровождаемый поток выполнения кода. Могут присутствовать косвенные вызовы (indirect calls) с использованием указателей на функции, где точка назначения вызова может зависеть от разных функций. Рекурсия и не снабженные подробными комментариями подпрограммы на ассемблере также будут создавать проблемы для тех, кто кочет вычислить максимальное использование стека по коду приложения.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Многие микроконтроллеры реализуют несколько аппаратных стеков, например системный стек (system stack) и стек пользователя (user stack). Несколько стеков также реальны, когда используются встраиваемые RTOS наподобие µC/OS, ThreadX и другие, где каждая задача получает свою собственную область стека. Runtime-библиотеки и библиотеки сторонних производителей - еще один фактор усложнения расчета стека, поскольку исходный код этих библиотек и RTOS может быть недоступен. Также важно помнить, что изменения кода и планировки приложения могут сильно повлиять на использование стека. Разные компиляторы и разные уровни оптимизации также генерируют разный код, который также будет по-разному использовать стек. В итоге получается, что важно постоянно отслеживать максимальные требования к размеру стека.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Как установить размер стека</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Когда разрабатывается приложение, размер стека это один из необходимых учитываемых факторов, и нужен какой-то метод для определения размера стека, который Вам необходим. Даже если Вы выделите всю оставшуюся память RAM под область стека, все еще необходимо убедиться, что места для стека достаточно. Один очевидный метод проверки системы - поместить её в условия худшего случая, когда должно наблюдаться самое максимальное использование пространства стека. Во время этого теста нужен метод определения, сколько реально использовалось места в стеке. Это можно сделать в основном двумя способами: из распечаток текущего использования стека, или путем создания в памяти отчета трассировки использования стека после того, как был завершен прогон теста. Но, как уже упоминалось выше, в большинстве сложных систем условия самого худшего случая создать очень трудно. Фундаментальная проблема тестирования реагирующей на события системы с многими прерываниями - большая вероятность, что некоторые пути выполнения все-таки не будут покрыты тестом.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Другой подход должен был бы вычислить теоретические максимальные требования к пространству стека. Очень просто понять, что невозможно вычислить вручную потребление стека полной системы. Это вычисление потребует инструмент, который может проанализировать всю систему. Этот инструмент должен работать либо с двоичным образом исполняемого кода, либо с исходным кодом. Двоичный инструментарий работает на уровне машинных инструкций, чтобы найти все возможные перемещения счетчика программы в коде и обнаружить самые худшие случаи пути выполнения. Утилита статического анализа исходного кода будет читать все используемые элементы компилируемого кода. В обоих случаях инструментарий должен быть в состоянии определить в каждом элементе компилируемого кода прямые и косвенные вызовы функции через указатели, вычисляя профиль консервативного использования стека через всю систему для всех деревьев вызовов. Инструменту анализа исходного кода также требуется знать, куда компилятор помещает стек, выравнивания ячеек памяти и временные ячейки компилятора.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Самостоятельное написание подобных инструментов сложное занятие, однако есть коммерческие альтернативы, либо отдельные инструменты статического обсчета стека, либо инструменты, предоставляемые производителем решения для компиляции. Например, утилита вычисления стека доступна для ThreadX RTOS от Express Logic.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Другие типы инструментов, у которых есть необходимая информация для вычисления максимального требования к стеку, это компилятор и линкер. Эта функциональность доступна для среды разработки IAR Embedded Workbench for ARM. Мы рассмотрим некоторые методы, которые можно использовать для оценки требований к размеру стека.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Различные методы установки размера стека</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Один из способов вычисления глубины стека - использование адреса текущего указателя стека. Это можно реализовать получением адреса аргумента функции или её локальной переменной. Если это сделать в начале функции main и для каждой из функций, на которую у Вас есть подозрение а большое использование стека, то Вы можете вычислить размер стека, который нужен приложению. Ниже приведен пример, где мы предполагаем, что стек растет от старших адресов памяти к младшим (так организован стек у большинства процессоров, в том числе MCS51, ARM, 8080): </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">char</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">highStack, </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">lowStack;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">int</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">main</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">int</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> argc, </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">char</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">argv[])</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   highStack </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">char</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">&amp;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">argc; </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">// ... </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   printf(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#ba2121;">&quot;Текущее использование стека (глубина): %d</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#bb6622;">\n</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#ba2121;">&quot;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">, highStack </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">-</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> lowStack); </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">// Самая &quot;подозрительная&quot; функция на предмет углубления в стек:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">deepest_stack_path_function</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">{ </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">int</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> a; </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   lowStack </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">char</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">&amp;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">a;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">// ... </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Этот метод может дать довольно хорошие результаты в небольших системах с детерминистским поведением, но для многих систем может быть сложно определить самое глубокое использование стека при вложенных вызовах функций и прерываний, чтобы добиться ситуации самого плохого случая.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Стоит заметить, что результаты, полученные этим методом, не учитывают использование стека функциями обработчиков прерываний.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Есть вариант этого метода - периодически делать выборку значения указателя стека внутри прерывания таймера, срабатывающего с достаточно высокой частотой. Частота прерываний таймера должна быть максимально возможной, пока она не начинает влиять на производительность реального времени приложения. Типичные частоты могут быть в диапазоне 10..250 кГц. Достоинство этого метода - не нужно вручную искать функцию с самым глубоким использованием стека. Также можно определять использование стека функциями обработки прерывания (ISR), если эта функция обработчика прерывания может вытеснять другие прерывания. Однако следует учитывать, что функции ISR обычно выполняются очень быстро, и анализирующая функция прерывания может пропустить короткий вызов одного из других прерываний. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">sampling_timer_interrupt_handler</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">char</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> currentStack;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">int</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> a;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   currentStack </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">char</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">&amp;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">a;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#008000;">if</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (currentStack </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">&lt;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> lowStack) lowStack </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> currentStack;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Защитная зона стека</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> (stack guard zone). Защитная зона стека это область памяти, размещенная непосредственно ниже стека, где стек оставляет следы, если происходит его переполнение. Этот метод всегда реализуется в настольных (больших) системах, где операционная система может быть просто настроена для детектирования ошибок защиты памяти в ситуациях переполнения стека. На малых встраиваемых системах без блока управления памятью (Memory Management Unit, MMU) защитная зона все еще может быть организована таким же способом, и это будет довольно полезно. Чтобы такая зона была достаточно эффективной, она должна иметь подходящий размер, чтобы поймать записи в эту защитную зону.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Постоянные проверки содержимого защитной зоны могут быть реализованы программно, чтобы firmware приложение определяло, что содержимое этой защитной зоны было нетронуто.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Самый лучший метод защитной зоны может быть реализован, если MCU оборудован (аппаратным) блоком защиты памяти (memory protection unit, MPU или MMU). В этом случае MPU может быть настроен таким образом, чтобы он срабатывал на записи в защитную зону. Если произошел такого рода недопустимый доступ, будет срабатывать исключение (exception), и обработчик исключения может записать или вывести в лог информацию о том, что произошло. Эту информацию можно будет впоследствии проанализировать.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image21153.png" style="vertical-align: top;" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Рис. 2. Стек с защитной (guard) зоной.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Заполнение области стека известными данными</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Одна из техник определения переполнения стека - заполнить все пространство стека заранее известной маской, например байтами 0xCD, перед тем, как приложение начнет свое выполнение. Всякий раз, когда приложение останавливается (например, с помощью отладчика), область памяти стека можно просмотреть в области его конца. В используемой области стека 0xCD не присутствует, потому что туда записывались адреса возврата и значения различных локально используемых регистров и переменных. Если в области стека не найдено значений маски (0xCD), то это означает, что стек переполнился.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Хотя этот способ детектирования переполнения стека достаточно надежен, все равно нет гарантии, что переполнение стека будет обнаружено. Например, стек может некорректно вырасти, переходя через свои границы, и даже изменить память вне области стека, причем без модификации каких-либо байт в области стека. Также стек может быть поврежден в его рабочей области. Это может произойти, например, в случае грубой ошибки, когда приложение ошибочно изменяет области памяти (в том числе и стека), какие оно изменять не должно.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Этот метод мониторинга стека широко используют отладчики. Это означает, что отладчик может отобразить использование стека подобно тому, как это показано на рис. 3. Обычно отладчик не обнаруживает переполнение стека, когда это произошло, он может только показать содержимое памяти стека, где будет видно заполнение данными.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image16798.png" style="vertical-align: top;" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Рис. 3. Окно стека в среде разработки IAR Embedded Workbench.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Вычисленное линкером требование к максимальному размеру стека</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Давайте теперь подробнее рассмотрим, как утилиты сборки приложения наподобие компилятора и линкера могут вычислить необходимый размер стека. В качестве примера мы будем здесь использовать компилятор и линкер IAR. Компилятор генерирует необходимую информацию, и при правильных обстоятельствах (когда программа работает ожидаемо для инструментария компиляции) линкер точно может вычислить использование стека для каждого корня графа вызовов (от каждой функции, которая не вызывается из другой функции, наподобие запуска приложения). Это вычисление размера стека будет точным только в том случае, когда присутствует точная информация по использованию стека каждой функцией приложения.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Обычно компилятор будет генерировать эту информацию для каждой функции языка C, но в некоторых ситуациях Вы должны сами предоставить для системы информацию, относящуюся к стеку. Например, если в приложении присутствуют косвенные вызовы функций, indirect call (с использованием указателей на функции), то Вы должны предоставить список возможных функций, которые могут быть вызваны из каждой вызываемой функции. Вы можете сделать это с помощью директив pragma в файле исходного кода, или с помощью отдельного файла для управления использования стека (stack usage control file) в процессе линковки. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">foo</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">int</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> i)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#bc7a00;">#pragma calls = fun1, fun2, fun3 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   func_arr[i](); </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Если Вы используете файл управления использования стека, то можете также предоставить информацию по использованию стека для функций в модулях, у которых нет информации по использованию стека. Тогда будет в состоянии генерировать предупреждения, также если отсутствует необходимая информация, например в следующих условиях приложения:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Имеется как минимум одна функция без информации по использованию стека.<br />• Имеется как минимум один косвенный вызов, для которого не предоставлен список возможных вызываемых функций.<br />• Нет известных косвенных вызовов, однако есть как минимум одна ни откуда не вызываемая функция, которая, как известно, не является корнем графа вызовов.<br />• Приложение содержит рекурсию (цикл в графе вызовов).<br />• Имеются вызовы функции, которая декларирована как корень графа вызовов.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Когда разрешен анализ использования стека, в генерируемый map-файл линкера будет добавлена секция использования памяти (usage), где перечисляется каждый граф вызовов от корня в виде цепочки вызовов до самого глубокого уровня использования стека.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image19627.png" style="vertical-align: top;" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Рис. 4. Результат вычисленного линкером максимального использования стека.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">[</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Надежный дизайн кучи</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Где тут можно сделать ошибку? Недооценка использования кучи может привести к ошибке при вызове malloc(), т. е. требуемая область памяти не будет выделена. Эту ситуацию можно очень просто отследить программно, проверяя результат вызова функции malloc(). Если она вернет NULL, то значит память не была выделена, но тогда может быть слишком поздно (если это произошло в рабочем изделии у заказчика). Это серьезная ситуация, поскольку в большинстве встраиваемых систем нет подходящего способа восстановления из ошибки по нехватке памяти в куче; есть только один доступный подходящий способ - перезапустить приложение. Переоценка использования кучи необходима из-за динамической природы работы кучи, однако слишком большое выделение памяти для кучи только впустую потратит ценные ресурсы памяти.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">При использовании кучи могут произойти две другие ошибки:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Перезапись данных кучи (переменные и указатели).<br />• Повреждение внутренней информационной структуры кучи.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Перед тем, как продолжить, давайте вспомним API выделения динамической памяти. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">malloc</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">size_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> size);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Функция malloc делает следующее:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Выделяет непрерывный блок памяти размера size байт.<br />• Возвращает указатель на начало этого выделенного блока.<br />• Не делает никакую очистку выделенного блока памяти.<br />• Вернет NULL, если в куче не осталось необходимого количества памяти. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">free</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> p);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Описание работы функции free:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Освобождает область памяти (ранее выделенный блок), на которую указывает аргумент p.<br />• Требует в качестве аргумента достоверного значения указателя p, которое было ранее получено из вызова malloc(), calloc() или realloc().<br />• Следует избегать нескольких вызовов free(p) для одного и того же значения p (после первого вызова free указатель p становится недостоверным). </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">calloc</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">size_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> nelem, </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">size_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> elsize);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Функция calloc работает подобно malloc(), но с тем отличием, что очищает выделенный блок памяти. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">realloc</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> p, </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">size_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> size);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Описание работы функции realloc:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Работает подобно malloc().<br />• Увеличивает или уменьшает (меняет размер) ранее выделенного блока.<br />• Возвращенный блок может иметь новый адрес.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">В C++ следующие встроенные операторы языка используют динамическую память кучи:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Оператор new, работающий подобно malloc().<br />• new[].<br />• Оператор delete, работающий подобно free().<br />• delete[].</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Имеется несколько вариантов реализации аллокатора динамической памяти. Наиболее часто сегодня используется Dlmalloc (Doug Lea’s Memory Allocator). Dlmalloc можно найти в Linux, а также во многих инструментах (библиотеках) разработки для встраиваемых систем. Dlmalloc свободно доступна для бесплатного использования (помещена в public domain).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Внутренняя структура кучи вкрапляется данными, выделенными приложением. Если приложение запишет память вне выделенных данных, то оно может легко нарушить внутреннюю связанную структуру кучи.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Рис. 5 дает некий упрощенный вид на то, как различные структуры данных окружают выделенные пользовательские данные (user data). Становится очевидным, что любая запись в область вне пользовательских данных серьезно повредит кучу.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image4516.png" style="vertical-align: top;" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Рис. 5. Окружение служебными данными выделенного из кучи блока для пользовательских данных.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Вычисление требования к размеру кучи является нетривиальной задачей, если куча используется активно, т. е. когда в процессе работы программы происходит множество циклов выделения и освобождения блоков памяти (обычно это так и есть, иначе куча была бы не нужна). Большинство разработчиков для выбора размера кучи прибегают к методу проб и ошибок, потому что другие альтернативы слишком утомительны. Типичный алгоритм определения размера кучи: найти самый малый размер кучи, при котором приложение все еще работает, затем к полученному размеру добавляют 50% сверху.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Предотвращение ошибок кучи</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Есть некий набор общих ошибок, допускаемых программистами и тестировщиками кода, которых следует изначально избегать, чтобы снизить риск выпуска продукции, где есть ошибки кучи.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Ошибки инициализации</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Не инициализированные глобальные данные всегда инициализируются нулями. Хорошо известный факт, что можно легко забыть о том, что вызовы malloc(), realloc() и оператор new языка C++ ничего подобного не делают, т. е. выделенная область данных заполнена мусором. Однако есть специальный вариант malloc(), носящий имя calloc(), который инициализирует нулями выделенный блок для данных. Оператор C++ new вызовет соответствующий конструктор, где следует гарантировать, что все элементы данных сконструированного (выделенного из кучи) объекта будут правильно инициализированы.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Неправильное разделение скаляров и массивов</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">На языке C++ есть разные операторы для скаляров и массивов: new и delete применяются для выделения и освобождения скаляров, и new[] и delete[] применяются для массивов.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Запись в уже освобожденную память</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Это либо повредит внутренние структуры данных аллокатора, либо эти данные будут перезаписаны позже в процессе легального выделения нового блока памяти. В любом случае это грубая ошибка, и подобные ошибки реально трудно перехватить и исправить.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Отсутствие проверки возвращенных значений</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Все вызовы malloc(), realloc() и calloc() возвратят указатель NULL, чтобы показать отсутствие свободной памяти (неудачное выделение блока памяти, out of memory). Настольные системы сгенерируют события отказа памяти (memory fault) и нехватки памяти (out-of-memory), так что эти ситуации просто отследить еще в процессе разработки. Встраиваемые системы могут быть устроены по-другому: по адресу 0 у них может быть память программ FLASH, и в них могут происходить больше других тонких ошибок. Если в Вашем MCU есть блок защиты памяти (memory protection unit, MPU), то следует сконфигурировать его таким образом, чтобы генерировались ошибки доступа к памяти при попытке доступа во FLASH и другие критические области (ОЗУ, где находится исполняемый код, защитная область стека и т. п.).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Освобождение несколько раз одного и того же блока памяти</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Это скорее всего повредит внутренние структуры аллокатора памяти, и такую ситуацию сложно определить и исправить.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">• Запись вне выделенной области</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Это также повредит внутренние структуры аллокатора памяти, и такую ситуацию сложно определить и исправить.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Последние три вида ошибок проще обнаружить, если Вы напишете обертки вокруг стандартных функций malloc(), free() и связанных с выделением памяти функций. Эти обертки должны выделять дополнительные байты памяти, где должна размещаться информация, необходимая для проверок целостности. Пример организации выделения памяти для данных такой обертки показана на рис. 6. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image1484.png" style="vertical-align: top;" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Рис. 6. Выделение памяти тестовой оберткой MyMalloc.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Здесь поле &quot;magic number&quot; перед данными (user data) используется для детектирования повреждения и будет проверен, когда память будет освобождаться. Поле size, находящееся ниже пользовательских данных, используется оберткой для free() (функция MyFree), чтобы найти &quot;magic number&quot;. Пример оберток, показанный ниже, использует 8 байт дополнительной нагрузки на одно выделение памяти, что вполне допустимо для большинства приложений. Этот пример также показывает, как глобально переопределить (override) операторы new и delete языка C++. Пример перехватит только ошибки такого рода, что вся выделенная память не была соответственно освобождена в какой-то момент времени. Для некоторых приложений такая проверка может не потребоваться. В этом случае обертка должна вести список всех выделений памяти, и периодически проверять все выделения, записанные в этом списке. Дополнительная нагрузка реализации этого может быть не такая большая, как это может показаться на первый взгляд, поскольку встраиваемые системы обычно не очень интенсивно используют динамическую память, сохраняя размер списка выделений в разумных пределах. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#bc7a00;">#include &lt; stdint.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#bc7a00;">#include &lt; stdlib.h&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#bc7a00;">#define MAGIC_NUMBER 0xefdcba98</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint32_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> myMallocMaxMem;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">MyMalloc</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">size_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> bytes)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint8_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">p, </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">p_end;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#008000;">static</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint8_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> mLow </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint8_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">0xffffffff</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">; </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* самый малый адрес, возвращенный</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">                                                   вызовом malloc() */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#008000;">static</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint8_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> mHigh;     </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* самый большой адрес + data, возвращенный malloc() */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   bytes </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (bytes </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">3</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">) </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">&amp;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">~3</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">;  </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* гарантирует выравнивание для magic number */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint8_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)malloc(bytes </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">8</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">); </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* учет области 2x32-бит для size и magic number */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#008000;">if</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">==</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#008000;">NULL</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">      abort(); </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* ошибка нехватки памяти, out of memory */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">((</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint32_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)p) </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> bytes; </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* запомнить размер size */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">((</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint32_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)(p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">4</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> bytes)) </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> MAGIC_NUMBER; </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* записать magic number после</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">                                                    пользовательского выделения */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* Грубый метод оценки максимального используемого размера</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">      с момента запуска приложения. */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#008000;">if</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">&lt;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> mLow) mLow </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> p;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   p_end </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> bytes </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">8</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#008000;">if</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (p_end </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">&gt;</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> mHigh) mHigh </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> p_end;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   myMallocMaxMem </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> mHigh </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">-</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> mLow;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#008000;">return</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">4</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">; </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* выделяемая область начинается после size */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">MyFree</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> vp)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint8_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint8_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)vp </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">-</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">4</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">int</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> bytes </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">((</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint32_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)p);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* Проверка, что magic number не был поврежден: */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#008000;">if</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">((</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint32_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)(p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">4</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> bytes)) </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">!=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> MAGIC_NUMBER)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">      abort(); </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* Ошибка: переполнение данных или освобождение блока</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">                  памяти, который уже был освобожден */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">((</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">uint32_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)(p </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">4</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">+</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> bytes)) </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">=</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">0</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">; </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">/* удаление magic number, чтобы можно было</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">                                         обнаружить ошибочно-повторное освобождение</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">                                         блока памяти */</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   free(p);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#bc7a00;">#ifdef __cplusplus</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">// Глобальное переназначение операторов new, delete, new[] и delete[].</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> operator </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">new</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">size_t</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> bytes) { </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600; color:#008000;">return</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> MyMalloc(bytes); }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> operator </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">delete</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">p) { MyFree(p); }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#bc7a00;">#endif</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Как установить размер кучи</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Итак, как можно определить требуемый минимальный размер кучи для приложения? Из-за того, что может произойти фрагментация памяти в процессе повторяющихся циклов освобождения и выделения памяти, ответ на этот вопрос нетривиален. Рекомендуется запустить тест системы при условиях, когда динамическая память будет использоваться по максимуму. Важно выполнить этот тест несколько раз, чтобы проанализировать переход от малого использования памяти кучи к интенсивному, и оценить её возможную фрагментацию. Когда тесты будут завершены, максимальный уровень выделения памяти в куче сравнивают с реально используемым размером кучи. Реальный размер кучи выставляют, добавляя от 25% до 100% к максимально определенному задействованному размеру кучи, в зависимости от того, как устроено приложение.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Для систем, которые тестируются на дестопных системах путем эмуляции sbrk(), максимальное использование кучи можно узнать через bymalloc_max_footprint().</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Для встраиваемых систем, которые не эмулируют sbrk() (а среда разработки IAR Embedded Workbench как раз относится к таким встраиваемым системам), обычно для аллокатора памяти предоставляют память кучи одним куском. В таком случае вызов malloc_max_footprint() становится бесполезным; он просто вернет размер всей кучи. Одним из решений может быть вызов mallinfo() после каждого вызова malloc(), например в обертке функции, описанной раннее, и получить обзор общего выделенного пространства (mallinfo-&gt;uordblks). Функция mallinfo() выполняет довольно интенсивные вычисления, так что её использование может повлиять на производительность системы. Лучший метод - записывать максимальные расстояния между выделенными областями памяти. Это просто осуществить, и показано в примере обертки; максимальное значение записывается в переменной myMallocMaxMem. Этот метод будет работать, когда куча предоставлена в одном непрерывной (не состоящей из отдельных кусков) области памяти.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">[</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Стек и куча в IAR 4.41</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">В этой старой версии IAR распределение памяти задается в файле *.xcl, который настраивается в опциях проекта (Options... -&gt; Linker -&gt; закладка Config -&gt; Linker command file). Стек начинается от старших (самых больших) адресов памяти и растет к нижним (самым малым адресам), навстречу к функциям __ramfunc и глобальным переменным. Вот пример настройки в XCL-файле, когда кучи нет, и определен только стек размера 400 байт: </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">//*************************************************************************</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">// Сегменты стека и кучи.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">//*************************************************************************</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">-D_CSTACK_SIZE=(100*4)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">-D_IRQ_STACK_SIZE=(3*8*4)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">-D_HEAP_SIZE=0</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Если в проекте определена куча, то она находится сразу за локальными переменными, и растет навстречу стеку. Вот другой пример, где определена куча размера 0x3C50 и стек размера 0x1D00: </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">-D_CSTACK_SIZE=(1D00)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">-D_IRQ_STACK_SIZE=(3*8*4)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">-D_HEAP_SIZE=3C50</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Вот так может выглядеть карта памяти RAM микроконтроллера AT91SAM7X256 для второго примера:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image16328.png" style="vertical-align: top;" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Определить, насколько корректно заданы размер кучи и размер стека, можно с помощью заполнения области кучи и стека заранее известным значением байта. Например, всю память кучи можно заполнить байтом 0xaa, а всю свободную память стека можно заполнить байтом 0xbb. Это целесообразно делать в функции </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600; color:#0000ff;">void AT91F_LowLevelInit(void)</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">, которая находится в модуле </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">Cstartup_SAM7.c</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Пример такого заполнения: </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#0000ff;">AT91F_LowLevelInit</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">(</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   ...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">//Заполнение кучи известным значением 0xAA:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#bc7a00;">   #define HEAP_BEGIN 0x0020A344                </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">//взято из map-файла PImain.map</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#bc7a00;">   #define HEAP_SIZE  0x3C50                    </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">//взято из map-файла PImain.map</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   memset((</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)HEAP_BEGIN, </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">0xAA</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">, HEAP_SIZE);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">//Заполнение стека известным значением 0xBB:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#bc7a00;">   #define STACK_BEGIN (HEAP_BEGIN+HEAP_SIZE)   </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">//стек начинается сразу за кучей</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#bc7a00;">   #define STACK_SIZE  0x1D00-0x0100)           </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">//взято из файла at91SAM7X256_FLASH.xcl</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">                                                </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-style:italic; color:#408080;">//с отступом 0x0100 байт от конца памяти</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">   memset((</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#b00040;">void</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">*</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">)STACK_BEGIN, </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt; color:#666666;">0xBB</span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">, STACK_SIZE);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Как узнать значения HEAP_BEGIN, HEAP_SIZE, STACK_BEGIN, STACK_SIZE</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; color:#0000ff;">HEAP_BEGIN</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> задает самый младший адрес области памяти кучи, а константа </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; color:#0000ff;">HEAP_SIZE</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> задает размер заполняемой области. Значение HEAP_BEGIN можно узнать опытным путем в отладчике по адресу первого выделенного блока (через malloc или new), или если заглянуть в конец map-файла, раздел &quot;SEGMENTS IN ADDRESS ORDER&quot;, там будет указаны начало и конец кучи, пример (параметры кучи выделены жирным шрифтом): </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">                ****************************************</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">                *                                      *</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">                *      SEGMENTS IN ADDRESS ORDER       *</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">                *                                      *</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">                ****************************************</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">SEGMENT              SPACE    START ADDRESS   END ADDRESS     SIZE  TYPE  ALIGN</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">=======              =====    =============   ===========     ====  ====  =====</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">ICODE                              00001000 - 0000111B         11C   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">CODE                               0000111C - 0000C5C7        B4AC   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">INITTAB                            0000C5C8 - 0000C5EB          24   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">DATA_ID                            0000C5EC - 00014B6F        8584   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">DATA_C                             00014B70 - 0001651F        19B0   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">CODE_ID                            00016520 - 000169A7         488   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">?FILL1                             000169A8 - 0003FFFF       29658   rel    0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">CODE_I                             00200050 - 002004D7         488   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">DATA_I                             002004D8 - 00208A5B        8584   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">DATA_Z                             00208A5C - 0020A33D        18E2   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#f8f8f8;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">DATA_N                             0020A340 - 0020A343           4   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt; font-weight:600;">HEAP                               0020A344 - 0020DF93        3C50   rel    2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">INTRAMEND_REMAP                         00210000                     rel    2 </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">HEAP_SIZE можно узнать из файла XCL в параметре HEAP_SIZE, или из того же map-файла, см. параметр SIZE таблицы выше.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; color:#0000ff;">STACK_BEGIN</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> задает самый младший адрес области памяти стека, а </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; color:#0000ff;">STACK_SIZE</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> задает размер заполняемой области. Значение STACK_BEGIN равно следующему за кучей адресу, а STACK_SIZE выбирается таким образом, чтобы заполнение памяти байтом 0xBB гарантированно не перекрыло содержимое стека, действующее в настоящий момент.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">После запуска программы в рабочий режим устанавливают условия, при котором должно наблюдаться максимальное использование стека и кучи. Дают программе некоторое время поработать, после чего останавливают отладчик, и после этого в дампе памяти можно увидеть, насколько далеко продвинулось заполнение стека и кучи. Те места, которые еще свободны, будут заполнены байтами 0xAA и 0xBB для кучи и стека соответственно. Ниже на скриншоте показано, как может выглядеть память кучи и стека. Видно, что выделение памяти в куче подошло к своему пределу, дополнительное выделение памяти в куче может привести к переходу на область стека:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image28521.png" style="vertical-align: top;" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">[</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Ссылки</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">1</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Mastering stack and heap for system reliability site:iar.com.<br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">2</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Nigel Jones, blog posts at embeddedgurus.com, 2007 and 2009.<br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">3</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. John Regehr &quot;Say no to stack overflow&quot;, EE Times Design, 2004.<br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">4</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">. Carnegie Mellon University, &quot;Secure Coding in C and C++, Module 4, Dynamic Memory Management&quot;, 2010.</span></p></td></tr></table></body></html>