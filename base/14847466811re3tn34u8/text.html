<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Режимы адресации</span>]</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Архитектура AVR имеет 4 указателя на память, которые используются для доступа к памяти данных и программ. Указатель стека (stack pointer, SP) специально выделен для хранения адреса возврата из функции. Компилятор C выделяет один указатель как стек параметра. Два остальных указателя являются указателями общего назначения, используемыми компилятором C для загрузки и сохранения данных. Пример ниже показывает, как эффективно использовать указатели для обычных операций с указателями на C.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">pointer1 </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;</span><span style=" font-family:'Courier New,courier';">table[</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">0</span><span style=" font-family:'Courier New,courier';">];</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">pointer2 </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;</span><span style=" font-family:'Courier New,courier';">table[</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">49</span><span style=" font-family:'Courier New,courier';">];</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">pointer1</span><span style=" font-family:'Courier New,courier'; color:#333333;">++</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*--</span><span style=" font-family:'Courier New,courier';">pointer2;</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; font-family:'Courier New,courier'; background-color:#ffffff;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;">Последний оператор примера сгенерирует следующий код ассемблера:</pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">LD</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#996633;">R16</span><span style=" font-family:'Courier New,courier';">,</span><span style=" font-family:'Courier New,courier'; color:#333333;">-</span><span style=" font-family:'Courier New,courier'; color:#996633;">Z</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#888888;">; преддекремент указателя Z и загрузка данных</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">ST</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#996633;">X</span><span style=" font-family:'Courier New,courier'; color:#333333;">+</span><span style=" font-family:'Courier New,courier';">,</span><span style=" font-family:'Courier New,courier'; color:#996633;">R16</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#888888;">; сохранение данных с постинкрементом указателя X</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ниже даны примеры для четырех режимом адресации с задействованием указателя. Все операции с указателями являются инструкциями из одного слова (2 байта кода), которые выполняются за 2 такта частоты ядра AVR.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Косвенная адресация (indirect addressing)</span>. Применяется для адресации в массивах и переменных указателя: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">pointer </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x00</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Косвенная адресация со смещением (indirect addressing with displacement)</span>. Позволяет получить доступ ко всем элементам в структуре путем указания на первый элемент структуры (через адрес указателя), и добавления смещения к адресу указателя (смещение указывает на нужное поле в структуре), причем значение указателя не изменяется. Также этот режим доступа используется для доступа к переменным в программном стеке и для доступа к ячейкам массива.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Косвенная адресация с постинкрементом (indirect addressing with post-increment)</span>. Применяется для эффективного доступа к элементам массива и к переменным указателя, когда нужен инкремент указателя после доступа: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">pointer</span><span style=" font-family:'Courier New,courier'; color:#333333;">++</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0xFF</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Косвенная адресация с преддекрементом (indirect addressing with pre-decrement)</span>. Применяется для эффективного доступа к элементам массива и к переменным указателя, когда нужен декремент указателя до доступа: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#333333;">*--</span><span style=" font-family:'Courier New,courier';">pointer </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0xFF</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Указатели также используются для доступа к памяти программ (FLASH). В дополнение к косвенной адресации через указатели, память данных может быть адресована напрямую (direct addressing). Это дает доступ ко всей памяти данных в инструкции, состоящей из 2 слов (4 байта кода).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Поддержка 16-битных и 32-битных переменных</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Набор инструкций AVR содержит специальные инструкции для работы с 16-битными числами. Они включают операцию сложения/вычитания над прямым значением и словом (Add/Subtract Immediate Values to Word), инструкции ADIW, SBIW. Арифметические операции и операции сравнения для 16-битных чисел состоят из 2 инструкций и выполняются за 2 такта частоты ядра. Есть 32-битные арифметические операции и операции сравнения, состоящие из 4 инструкций, и выполняющихся за 4 такта частоты ядра. Это эффективнее, чем аналогичные показатели у большинства 16-битных процессоров!</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Инициализация указателя стека (Stack Pointer)</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">После подачи питания на микроконтроллер или после сброса (RESET) нужно загрузить указатель стека до того, как будет вызвана любая функция. Командный файл для линкера определяет размещение в памяти и размер стека, что и послужит информацией для настройки указателя стека. Конфигурирование стека (объема задействованной памяти под стек) и его настройка обсуждается в даташите AVR032 [2].</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Доступ к ячейкам памяти пространства ввода/вывода (I/O)</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Память ввода вывода AVR легко доступна на языке C. Все регистры в области памяти I/O декларируются в заголовочном файле, который именуется на основе модели микроконтроллера, наподобие ioxxxx.h, где xxxx указывает на тип AVR. Ниже показан код, где приведены примеры доступа к пространству памяти ввода/вывода. Ниже оператора на языке C приведен соответствующий код ассемблера, который будет сгенерирован для этого оператора.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; color:#557799;">#include &lt; io8515.h &gt;</span></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Декларирование переменной для промежуточных данных </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// для чтения и записи через регистр I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> temp;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   temp </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> PIND;            </span><span style=" font-family:'Courier New,courier'; color:#888888;">// чтение регистра PIND в переменную</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// IN R16, LOW(16) ; чтение памяти I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   TCCR0 </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x4F</span><span style=" font-family:'Courier New,courier';">;           </span><span style=" font-family:'Courier New,courier'; color:#888888;">// запись значения в ячейку I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// LDI R17,79 ; загрузка значения</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// OUT LOW(51),R17 ; запись в память I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Установка или сброс одного бита:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   PORTB </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier'; color:#333333;">&lt;&lt;</span><span style=" font-family:'Courier New,courier';">PD2);      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// PD2 задает номер разряда (0..7) порта</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// SBI LOW(24),LOW(2) ; установка бита в пространстве I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   ADCSR </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">~</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier'; color:#333333;">&lt;&lt;</span><span style=" font-family:'Courier New,courier';">ADEN);    </span><span style=" font-family:'Courier New,courier'; color:#888888;">// очистка бита ADEN в регистре ADCSR</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// CBI LOW(6),LOW(7) ; очистка бита в пространстве I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Установка и очистка через битовую маску:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   DDRD </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x0C</span><span style=" font-family:'Courier New,courier';">;           </span><span style=" font-family:'Courier New,courier'; color:#888888;">// установка битов 2 и 3 регистра DDRD</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// IN R17,LOW(17) ; чтение памяти I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// ORI R17,LOW(12) ; модификация</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// OUT LOW(17),R17 ; запись памяти I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   ACSR </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">~</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x0C</span><span style=" font-family:'Courier New,courier';">);        </span><span style=" font-family:'Courier New,courier'; color:#888888;">// очистка битов 2 и 3 регистра ACSR</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// IN R17,LOW(8) ; чтение памяти I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// ANDI R17,LOW(243) ; модификация</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// OUT LOW(8),R17 ; запись памяти I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">//Проверка: установлен или очищен один бит:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';">(USR </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier'; color:#333333;">&lt;&lt;</span><span style=" font-family:'Courier New,courier';">TXC))      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Проверка флага UART Tx</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      PORTB </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier'; color:#333333;">&lt;&lt;</span><span style=" font-family:'Courier New,courier';">PB0);</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// SBIC LOW(11),LOW(6) ; прямая проверка I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// SBI LOW(24),LOW(0)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">while</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; color:#333333;">!</span><span style=" font-family:'Courier New,courier';">(SPSR </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier'; color:#333333;">&lt;&lt;</span><span style=" font-family:'Courier New,courier';">WCOL)));   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// ожидание установки флага WCOL</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// ?0003:SBIS LOW(14),LOW(6) ; прямая проверка I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// RJMP ?0003</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Test if an I/O register equals a bitmask */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';">(UDR </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0xF3</span><span style=" font-family:'Courier New,courier';">)       </span><span style=" font-family:'Courier New,courier'; color:#888888;">// проверка на 0 результата операции AND над регистром</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">                           </span><span style=" font-family:'Courier New,courier'; color:#888888;">// UDR и константой 0xF3</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      }</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// IN R16,LOW(12) ; чтение памяти I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// ANDI R16,LOW(243) ; операция AND</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// BREQ ?0008 ; переход, если равно</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">//?0008:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   }</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Установку и очистку битов в регистрах I/O можно определить макросами:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   #define SETBIT(ADDRESS,BIT)   (ADDRESS </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier';">  (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier'; color:#333333;">&lt;&lt;</span><span style=" font-family:'Courier New,courier';">BIT))</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   #define CLEARBIT(ADDRESS,BIT) (ADDRESS </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">~</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier'; color:#333333;">&lt;&lt;</span><span style=" font-family:'Courier New,courier';">BIT))</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Макрос для проверки одного бита ячейки в пространстве I/O:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   #define CHECKBIT(ADDRESS,BIT) (ADDRESS </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier'; color:#333333;">&lt;&lt;</span><span style=" font-family:'Courier New,courier';">BIT))</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">//Пример использования:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';">(CHECKBIT(PORTD,PD1))    </span><span style=" font-family:'Courier New,courier'; color:#888888;">// проверка, установлен ли разряд 1 порта D</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      CLEARBIT(PORTD,PD1);    </span><span style=" font-family:'Courier New,courier'; color:#888888;">// сброс разряда 1 порта D</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   }</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; color:#333333;">!</span><span style=" font-family:'Courier New,courier';">(CHECKBIT(PORTD,PD1))) </span><span style=" font-family:'Courier New,courier'; color:#888888;">// проверка, сброшен ли разряд 1 порта D</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      SETBIT(PORTD,PD1);      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// установка разряда 1 порта D</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   }</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Адресация Memory Mapped I/O</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Некоторые микроконтроллеры AVR имеют на борту специальный интерфейс для доступа к внешней памяти данных. Этот интерфейс может использоваться для доступа к внешней памяти RAM, EEPROM, или его можно использовать как ввод/вывод, привязанный к ячейкам памяти (memory mapped I/O). Следующие примеры показывают, как декларировать, записывать и читать ячейки memory mapped I/O: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#include &lt; io8515.h &gt;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define reg (* (char *) 0x8004) </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Декларирование адреса memory mapped I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> xram;  </span><span style=" font-family:'Courier New,courier'; color:#888888;">// локальная переменная для промежуточных данных</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   reg </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x05</span><span style=" font-family:'Courier New,courier';">; </span><span style=" font-family:'Courier New,courier'; color:#888888;">// запись значения по адресу memory mapped I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   xram </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> reg; </span><span style=" font-family:'Courier New,courier'; color:#888888;">// чтение адреса memory mapped I/O</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Доступ к следующим друг за другом адресам наиболее эффективен, если декларировать постоянный указатель, и добавить к нему значение смещения. Пример ниже показывает, как таким методом получить доступ к memory mapped I/O. Для каждой инструкции показан сгенерированный код ассемблера. </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// Определение адресов, привязанных к памяти (memory mapped addresses)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define data 0x0003</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define address_high 0x0002</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define address_low 0x0001</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Начальный адрес в карте памяти</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">unsigned</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">pointer </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">unsigned</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">) </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x0800</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// LDI R30,LOW(0) ; инициализация Z-указателя</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// LDI R31,8</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">(pointer</span><span style=" font-family:'Courier New,courier'; color:#333333;">+</span><span style=" font-family:'Courier New,courier';">address_low) </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x40</span><span style=" font-family:'Courier New,courier';">; </span><span style=" font-family:'Courier New,courier'; color:#888888;">// чтение и модификация ячейки по адресу</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// LDD R18,Z+1 ; загрузка переменной</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// ORI R18,LOW(64) ; модификация</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// STD Z+1,R18 ; сохранение обратно</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">(pointer</span><span style=" font-family:'Courier New,courier'; color:#333333;">+</span><span style=" font-family:'Courier New,courier';">address_high) </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x00</span><span style=" font-family:'Courier New,courier';">; </span><span style=" font-family:'Courier New,courier'; color:#888888;">// запись по адресу</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// STD Z+2,R30 ; сохранение нуля</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   PORTC </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">(pointer</span><span style=" font-family:'Courier New,courier'; color:#333333;">+</span><span style=" font-family:'Courier New,courier';">data);        </span><span style=" font-family:'Courier New,courier'; color:#888888;">// чтение по адресу и вывод в порт</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// LDD R16,Z+3 ; загрузка переменной</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// OUT LOW(21),R16 ; вывод в порт</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обратите внимание, что Z-указатель инициализируется до доступа к памяти, и после этого инструкции LDD и STD (Load and Store with Displacement) используются для доступа к данным. Инструкции LDD и STD состоят из одного слова и выполняются за 2 такта частоты ядра. Указатель Z загружается только 1 раз. Ячейки памяти, привязанные к вводу/выводу (Memory mapped I/O locations) могут быть декларированы как volatile, что говорит о том, что они могут быть неожиданно изменены аппаратурой, и доступ к ним не будет удален при оптимизации.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Доступ к данным EEPROM</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Во время нормального выполнения кода внутренняя память EEPROM микроконтроллера AVR может быть прочитана и записана. Макросы компилятора IAR для чтения и записи EEPROM находятся в файле ina90.h. Обычно для чтения и записи EEPROM определены следующие макросы: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define _EEGET(VAR,ADR)</span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Чтение данных EEPROM по адресу ADR в переменную VAR */</span><span style=" font-family:'Courier New,courier'; color:#557799;"> \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">{ \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;"> while(EECR &amp; 0x02); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Проверка: готова ли EEPROM к записи */</span><span style=" font-family:'Courier New,courier'; color:#557799;"> \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;"> EEAR = (ADR); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запись регистра адреса EEPROM */</span><span style=" font-family:'Courier New,courier'; color:#557799;"> \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;"> EECR |= 0x01; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установка строба чтения */</span><span style=" font-family:'Courier New,courier'; color:#557799;"> \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;"> (VAR) = EEDR; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Чтение данных в переменную за следующий цикл */</span><span style=" font-family:'Courier New,courier'; color:#557799;"> \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">}</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define _EEPUT(ADR,VAL) </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запись VAL в EEPROM по адресу ADR */</span><span style=" font-family:'Courier New,courier'; color:#557799;">\</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">{\</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;"> while(EECR&amp;0x02); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Проверка: готова ли EEPROM к записи */</span><span style=" font-family:'Courier New,courier'; color:#557799;"> \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;"> EEAR = (ADR); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запись регистра адреса EEPROM */</span><span style=" font-family:'Courier New,courier'; color:#557799;"> \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;"> EEDR = (VAL); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запись регистра данных EEPROM */</span><span style=" font-family:'Courier New,courier'; color:#557799;"> \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;"> EECR |= 0x04; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установка сигнала мастера записи */</span><span style=" font-family:'Courier New,courier'; color:#557799;"> \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;"> EECR |= 0x02; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установить строб записи */</span><span style=" font-family:'Courier New,courier'; color:#557799;"> \</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пример кода для чтения и записи EEPROM с использованием предопределенных макросов: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#include &lt; io8515.h &gt;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#include &lt; ina90.h &gt;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define EE_ADDRESS 0x010 </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Определение константы адреса для данных EEPROM */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> temp;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   _EEGET(temp,EE_ADDRESS);   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// чтение данных из EEPROM</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   temp </span><span style=" font-family:'Courier New,courier'; color:#333333;">+=</span><span style=" font-family:'Courier New,courier';"> UDR;               </span><span style=" font-family:'Courier New,courier'; color:#888888;">// добавить данные UART к переменной temp</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   _EEPUT(EE_ADDRESS,temp);   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// записать данные в EEPROM</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Имейте в виду, что если разрешены прерывания, то их нужно запретить во время процесса записи EEPROM, чтобы избежать таймаута бита Master Write Enable (EEMWE). Если программа включает в себя доступ к EEPROM внутри обработчиков прерывания, прерывания должны быть также запрещены перед чтением EEPROM, чтобы избежать порчи регистра адреса EEPROM.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Создание файлов данных в EEPROM (EEPROM Data Files)</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В некоторых случаях удобно разместить некоторые начальные данные в EEPROM, и получать к ним доступ из кода C. Инструментарий IAR может использоваться для генерирования начальных данных для EEPROM. С помощью заголовочных файлов, где определены структуры, можно гарантировать, что структуры в EEPROM будут доступны из программы на C.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Данные EEPROM и код программы составляют 2 отдельных проекта, которые должны быть скомпилированы и линкованы по отдельности. Заголовочный файл, описывающий структуру памяти EEPROM, используется в обоих проектах - чтобы гарантировать, что данные в памяти EEPROM могут быть доступны по своим символическим именам.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Эта технология будет продемонстрирована на примере, где подразумевается, что в EEPROM находятся следующие настроечные данные:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">1. Массив символов (100 байт)<br />2. Целое число (2 байта)<br />3. Два беззнаковых символа (каждый по 1 байту)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Файл заголовка EEPROM</span>. Этот файл eeprom.h подключается и к проекту, который определяет содержимое EEPROM, и к проекту программы, которая получает доступ к EEPROM на языке C. Вот содержимое этого файла заголовка: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define EEPROMADR(x) (unsigned int) (&amp;((TypeEEPROMStruct *)0x0000)-&gt;x)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">typedef</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">struct</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> cArray[</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">100</span><span style=" font-family:'Courier New,courier';">];             </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* массив символов */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">int</span><span style=" font-family:'Courier New,courier';"> iNumber;                  </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* целое число */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">unsigned</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> uMinorVersion;  </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* младший код версии */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">unsigned</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> uMajorVersion;  </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* старший код версии */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">} TypeEEPROMStruct; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* имя типа */</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Директива #define содержит макрос для использования в программе C - чтобы получить адрес переменной структуры. Макрос содержит указатель-константу (0x0000). Чтобы разместить содержимое данных в EEPROM в нужном месте, этот указатель должен быть изменен (это также потребует изменение в файле линкера EEPROM, см. ниже).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Файл программы (содержимого) EEPROM</span>. Файл eeprom.c содержит инициализацию структуры, определенной в заголовочном файле EEPROM (eeprom.h). </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#include &quot;eeprom.h&quot; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Подключение определения типа структуры */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#pragma memory=constseg(EEPROM) </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Создать структуру в именованном сегменте */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">const</span><span style=" font-family:'Courier New,courier';"> TypeEEPROMStruct __EEPROMInitializationData </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; background-color:#fff0f0;">&quot;Testing &quot;</span><span style=" font-family:'Courier New,courier';">,    </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* инициализация cArray */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x100</span><span style=" font-family:'Courier New,courier';">,         </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* инициализация iNumber */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x10</span><span style=" font-family:'Courier New,courier';">,          </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* инициализация uMinorVersion */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0xFF</span><span style=" font-family:'Courier New,courier';">           </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* инициализация uMajorVersion */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">};</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Конфигурационный файл линкера для EEPROM</span>. Для линковки программы EEPROM нужен очень простой файл линкера (eeprom.xcl): </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">-ca90                      -! Определение модели CPU (AVR) -!</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">-Z(CODE)EEPROM=0-1FF       -! Адресное пространство EEPROM (внутренняя EEPROM AVR) -!</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Адресное пространство установлено здесь в диапазоне 0..1FF (для примера AT90S8515), и оно должно соответствовать диапазону, который используется в микроконтроллере. Имя сегмента &quot;EEPROM&quot;, и оно должно соответствовать директиве #pragma memory=constseg(EEPROM) в файле исходного кода eeprom.c.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если нужно разместить содержимое структуры по другому адресу EEPROM, то начальный адрес сегмента EEPROM должен быть изменен (см. также описание в секции заголовочного файла EEPROM).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Сборка файла данных EEPROM в формате Intel HEX</span>. Чтобы сгенерировать файл данных содержимого EEPROM в формате Intel-Hex [3], нужно выполнить следующие команды (обратите внимание, что опции -v1 -ms и т. д. не важны для вызова icca90): </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">icca90 eeprom.c</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">xlink -f eeprom.xcl -B -Fintel-standard eeprom.r90 -o eeprom.hex</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Во время линковки будет выдано следующее сообщение об ошибке: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">Error[46]: Undefined external ?CL0T_1_41_L08 referred in eeprom ( eeprom.r90 )</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Причина в том, что программа на C ссылается на внешний пустой символ (dummy symbol, ?CL0T_1_41_L08), чтобы гарантировать, что компилируемая программа линкована с корректной версией библиотеки. Поскольку нам не нужна линковка никакой библиотеки, то мы можем игнорировать эту ошибку, и опция -B гарантирует, что выходной файл eeprom.hex будет сгенерирован в любом случае, даже если будет выдано сообщение об ошибке. Можно поступить и по другому, если запустить сборку со следующими опциями: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">xlink -f eeprom.xcl -D?CL0T_1_41_L08=0 -Fintel-standard eeprom.r90 -o eeprom.hex</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Заданный символ зависит от версии процессора (-v0, -v1 и т. д.), модели памяти (-mt, -ms, и т. д.), а также от версии компилятора, так что имя этого символа может меняться от одной инсталляции к другой (сначала попытайтесь выполнить линковку, проверьте о каком неопределенном символе сообщается, и затем используйте его имя в опции -D). Содержимое сгенерированного файла будет примерно таким (eeprom.hex): </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">:1000000054657374696E67202000000000000000D2</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">:1000100000000000000000000000000000000000E0</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">:1000200000000000000000000000000000000000D0</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">:1000300000000000000000000000000000000000C0</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">:1000400000000000000000000000000000000000B0</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">:1000500000000000000000000000000000000000A0</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">:0800600000000000000110FF88</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">:00000001FF</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Получение доступа к структуре в EEPROM из программы на языке C</span>. Здесь приведен простой пример программы, которая использует определенную структуру EEPROM для получения доступа к EEPROM (главный модуль программы main.c): </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#include &quot;eeprom.h&quot; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Мы используем структуру и макрос */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#include &lt; io8515.h &gt; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Определения имен регистров EEPROM */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">/* Подпрограмма обработки ошибок */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">error</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">for</span><span style=" font-family:'Courier New,courier';">(;;)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   ;        </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Ничего не делать, ошибка */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">int</span><span style=" font-family:'Courier New,courier';"> i; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Используется для чтения EEPROM */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   EEAR </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> EEPROMADR(cArray);        </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установка адреса для 1 элемента */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   EECR </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;                        </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запуск чтения EEPROM */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';">(EEDR </span><span style=" font-family:'Courier New,courier'; color:#333333;">!=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#0044dd;">'T'</span><span style=" font-family:'Courier New,courier';">)                  </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Проверка инициализации */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      error();                      </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Нет соответствия -&gt; ошибка */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   EEAR </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> EEPROMADR(iNumber);       </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установка адреса для 2 элемента */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   EECR </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;                        </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запуск чтения EEPROM */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   i </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> EEDR ;                       </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установить младший байт i */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   EEAR </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> EEPROMADR(iNumber)</span><span style=" font-family:'Courier New,courier'; color:#333333;">+</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;     </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установка адреса для второго байта */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   EECR </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;                        </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запуск чтения EEPROM */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   i </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier';"> EEDR</span><span style=" font-family:'Courier New,courier'; color:#333333;">&lt;&lt;</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">8</span><span style=" font-family:'Courier New,courier';">;                    </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установить старший байт i */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';">(i</span><span style=" font-family:'Courier New,courier'; color:#333333;">!=</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x100</span><span style=" font-family:'Courier New,courier';">)                     </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Проверка инициализации */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      error();                      </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Нет соответствия -&gt; ошибка */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   EEAR </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> EEPROMADR(uMinorVersion); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установка адреса для 3 элемента */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   EECR </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;                        </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запуск чтения EEPROM */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';">(EEDR </span><span style=" font-family:'Courier New,courier'; color:#333333;">!=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x10</span><span style=" font-family:'Courier New,courier';">)                 </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Проверка инициализации */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      error();                      </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Нет соответствия -&gt; ошибка */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   EEAR </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> EEPROMADR(uMajorVersion); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установка адреса для 4 элемента */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   EECR </span><span style=" font-family:'Courier New,courier'; color:#333333;">|=</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;                        </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запуск чтения EEPROM */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';">(EEDR </span><span style=" font-family:'Courier New,courier'; color:#333333;">!=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0xFF</span><span style=" font-family:'Courier New,courier';">)                 </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Проверка инициализации */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      error();                      </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Нет соответствия -&gt; ошибка */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">for</span><span style=" font-family:'Courier New,courier';"> (;;)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      ; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Ничего не делать (успешное завершение) */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Программа может быть скомпилирована в AVR Studio. Файл eeprom.hex должен быть предварительно загружен в память EEPROM с помощью программатора до запуска программы, иначе выполнение будет останавливаться в процедуре error(). EEPROM может быть загружено файлом eeprom.hex через меню File -&gt; Up/Download после того, как программа будет загружена (понадобится ISP программатор AVR наподобие AVRISP-mkII или любой другой [4]).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Переменные и типы данных</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поскольку AVR является 8-разрядным микроконтроллером, постарайтесь ограничить использование 16-битных и 32-битных переменных за исключением тех случаев, когда это абсолютно необходимо. Следующий пример покажет размер кода для 8-битной и 16-битной переменной: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">//8-битный счетчик</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">unsigned</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> count8 </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">5</span><span style=" font-family:'Courier New,courier';">; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Декларирование переменной, присваивание ей значения */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// LDI R16,5 ; инициализация переменной</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">do</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запуск цикла */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">while</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; color:#333333;">--</span><span style=" font-family:'Courier New,courier';">count8); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Декремент счетчика цикла и проверка его на 0 */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// ?0004:DEC R16 ; декремент</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// BRNE ?0004 ; переход, если не равно</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">//16-битный счетчик</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">unsigned</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">int</span><span style=" font-family:'Courier New,courier';"> count16 </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">6</span><span style=" font-family:'Courier New,courier';">; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Декларирование переменной, присваивание ей значения */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// LDI R24,LOW(6) ; инициализация младшего байта переменной</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// LDI R25,0 ; инициализация старшего байта переменной</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">do</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Запуск цикла */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">while</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; color:#333333;">--</span><span style=" font-family:'Courier New,courier';">count16); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Декремент счетчика цикла и проверка его на 0 */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// ?0004:SBIW R24,LWRD(1) ; вычесть из 16-битного значения</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// BRNE ?0004 ; переход, если не равно</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Таким образом, для 8-битной переменной в этом примере задействовано 6 байт кода, а для 16-битной переменной 8 байт кода.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Эффективное использование переменных на C</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Программа на языке C обычно делится на множество функций, которые выполняют маленькие или большие задачи. Функции принимают данные через параметры, и также могут возвратить данные. Переменные, которые используются внутри функции, называются локальными. Переменные, декларированные вне функции, называются глобальными. Локальные переменные, у которых должно сохраняться значение между отдельными вызовами функции, должны быть декларированы с атрибутом static (статическая локальная переменная).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Глобальные переменные, которые декларированы вне функции, размещаются в памяти SRAM. Место в SRAM резервируется для глобальной переменной, и оно не может использоваться для других целей, так что место в SRAM тратится. Кроме того, если глобальных переменных слишком много, то код становится нечитаемым, его сложно модифицировать и поддерживать, и велика вероятность возникновения трудно обнаруживаемых ошибок.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Локальные переменные назначаются в первую очередь не в SRAM, а на регистры (регистровый файл). Локальная переменная сохраняет свое значение, пока выполняется тело функции, и после выхода из функции теряет свое значение. Глобальные переменные должны быть загружены из SRAM в рабочие регистры перед доступом к ним.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Следующий пример иллюстрирует разницу в размере кода и скорости работы кода для локальных переменных в сравнении с глобальными. </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> global; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Это глобальная переменная */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> local;    </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Это локальная переменная */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   global </span><span style=" font-family:'Courier New,courier'; color:#333333;">-=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">45</span><span style=" font-family:'Courier New,courier';">;  </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Вычитание из глобальной переменной */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// LDS R16,LWRD(global) ; загрузка переменной из SRAM в регистр R16</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// SUBI R16,LOW(45) ; выполнение вычитания</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// STS LWRD(global),R16 ; сохранение данных обратно в SRAM</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   local </span><span style=" font-family:'Courier New,courier'; color:#333333;">-=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">34</span><span style=" font-family:'Courier New,courier';">;   </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Вычитание из локальной переменной */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// SUBI R16,LOW(34) ; выполнение вычитания напрямую из локальной</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// ; переменной в регистре R16</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обратите внимание, что инструкции LDS и STS (загрузка из SRAM и сохранение в SRAM) используются для для доступа к переменной в SRAM. Эти инструкции занимают 2 слова инструкций, и выполняются за 2 цикла тактовой частоты. Для этого примера получается следующее: для глобальной переменной 10 байт кода и 5 циклов, для локальной переменной 2 байта кода и 1 цикл.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Статические локальные переменные загружаются в рабочий регистр (регистровый файл) при запуске функции, и сохраняются обратно в SRAM при возврате из функции. Таким образом, статические переменные дают более эффективный код, чем глобальные переменные, если в теле функции доступ к переменной осуществляется больше одного раза.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы ограничить использование глобальных переменных, функции могут быть вызваны с параметрами и возвращать значение, которое может использоваться на C как обычно. Если для передачи функции используется до 2 параметров простого типа (char, int, float, double), то они передаются через регистры R16..R23. Если у функции 2 параметров, или в параметре передаются сложные типы данных (массивы, структуры), то они при вызове функции помещаются либо в программный стек, либо передаются между функциями как указатели на ячейки в SRAM.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда нужны глобальные переменные, то они должны быть собраны в структуры, если это уместно. Это делает возможным для компилятора адресовать их косвенно (indirect addressing). В следующем примере показана генерация кода для случая использования глобальных переменных в сравнении с использованием глобальной структуры. </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">typedef</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">struct</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> sec;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}t;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">t global;   </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Декларирование глобальной структуры */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> min;   </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Декларирование глобальной переменной */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   t </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">time </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;</span><span style=" font-family:'Courier New,courier';">global;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// LDI R30,LOW(global) ; инициализация указателя Z</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// LDI R31,(global &gt;&gt; 8) ; инициализация старшего байта Z</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; color:#333333;">++</span><span style=" font-family:'Courier New,courier';">time</span><span style=" font-family:'Courier New,courier'; color:#333333;">-&gt;</span><span style=" font-family:'Courier New,courier';">sec </span><span style=" font-family:'Courier New,courier'; color:#333333;">==</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">60</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// LDD R16,Z+2 ; загрузка со смещением (Load with displacement)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// INC R16 ; инкремент</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// STD Z+2,R16 ; сохранение со смещением (Store with displacement)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// CPI R16,LOW(60) ; сравнение</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// BRNE ?0005 ; переход по метке ?0005, если не равно</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   }</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';"> ( </span><span style=" font-family:'Courier New,courier'; color:#333333;">++</span><span style=" font-family:'Courier New,courier';">min </span><span style=" font-family:'Courier New,courier'; color:#333333;">==</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">60</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// LDS R16,LWRD(min) ; прямая загрузка из SRAM</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// INC R16 ; инкремент</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// STS LWRD(min),R16 ; прямое сохранение в SRAM</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// CPI R16,LOW(60) ; сравнение</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; color:#888888;">// BRNE ?0005 ; переход по метке ?0005, если не равно</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   }</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда происходит доступ к глобальным переменным через структуру, то компилятор использует указатель Z и инструкции LDD и STD (Load/store with displacement) для доступа к данным переменной. Когда глобальная переменная определена без структуры, компилятор использует инструкции LDS и STS (Load/store direct to SRAM). Различие в размере кода для этого примера получается следующее: для кода со структурой тратится 10 байт под код доступа к переменной, а для переменной без структуры 14 байт. Разница очевидна, однако тут не учитывается инициализация указателя Z на адрес начала структуры (4 байта). Таким образом, если имеется доступ к одному байту, то экономии в размере кода не будет, но если структура содержит несколько переменных - 2 байта или более, то использование глобальной структуры будет эффективнее, чем использование глобальных переменных.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Неиспользуемые места в памяти I/O могут быть задействованы под сохранение глобальных переменных, когда соответствующая периферия не используется. Например, если UART не используется в программе, то как ячейка памяти доступен регистр выбора скорости UART Baud Rate<br />Register (UBRR). Аналогично, если не используется EEPROM, то можно в программе под глобальные переменные использовать регистр данных EEPROM data register (EEDR) и регистр адреса EEPROM Address Register (EEAR).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Доступ к I/O memory очень эффективен, и в ячейках I/O memory ниже 0x1F могут адресоваться отдельные биты.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Что эффективнее - битовые поля или битовые маски?</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы экономить на байтах памяти, когда нужно сохранять двоичные флаги, можно эти флаги хранить в отдельных битах одного байта. Получается байт состояния, в котором упаковано несколько битовых флагов. Этот функционал можно реализовать двумя способами: получать доступ к флагам либо через битовую маску (bit-mask), либо через битовые поля (bit-field, см. [5]). Ниже приведен пример использования битовой маски и битового поля для декларирования байта состояния (status byte): </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">/* Использование bit-mask для битов состояния */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">/* Определение битовых макросов, которые работают аналогично макросам I/O */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define SETBIT(x,y) (x |= (y)) </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Установка бита y в байте x */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define CLEARBIT(x,y) (x &amp;= (~y)) </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Очистка бита y в байте x */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define CHECKBIT(x,y) (x &amp; (y)) </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Проверка бита y в байте x */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">/* Определение констант маски для битов состояния */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define RETRANS 0x01 </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* bit 0 : флаг повторной передачи */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define WRITEFLAG 0x02 </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* bit 1 : флаг устанавливается, когда должна быть запись */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define EMPTY 0x04 </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* bit 2 : флаг опустошения буфера */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define FULL 0x08 </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* bit 3 : флаг заполнения буфера */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">  </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> status; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Декларирования байта состояния (status byte) */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Очистка флагов RETRANS и WRITEFLAG:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   CLEARBIT(status,RETRANS); </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   CLEARBIT(status,WRITEFLAG);</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Проверка: очищен ли флаг RETRANS:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; color:#333333;">!</span><span style=" font-family:'Courier New,courier';">(CHECKBIT(status, RETRANS)))</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      SETBIT(status,WRITEFLAG);</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   }</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Битовые маски обрабатываются компилятором C очень эффективно, если переменная состояния декларирована как локальная, и используется в пределах функции. Альтернативно с битовыми масками используйте незанятые ячейки I/O, это тоже эффективно.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">А вот тот же самый код, но с использованием битовых полей: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">/* Использование битовых полей для битов состояния */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">struct</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> RETRANS</span><span style=" font-family:'Courier New,courier'; color:#333333;">:</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;     </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* bit 0 : флаг повторной передачи */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> WRITEFLAG </span><span style=" font-family:'Courier New,courier'; color:#333333;">:</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;  </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* bit 1 : флаг устанавливается, когда должна быть запись */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> EMPTY </span><span style=" font-family:'Courier New,courier'; color:#333333;">:</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;      </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* bit 2 : флаг опустошения буфера */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> FULL </span><span style=" font-family:'Courier New,courier'; color:#333333;">:</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;       </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* bit 3 : флаг заполнения буфера */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   } status; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Декларирование байта состояния (status byte) */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Очистка флагов RETRANS и WRITEFLAG:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   status.RETRANS </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">0</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   status.WRITEFLAG </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">0</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Проверка: очищен ли флаг RETRANS:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; color:#333333;">!</span><span style=" font-family:'Courier New,courier';">(status.RETRANS))</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      status.WRITEFLAG </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   }</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Битовые поля не сохраняются локально в регистровом файле в пределах функции, однако проталкивается в стек и извлекается оттуда каждый раз, когда к ним осуществляется доступ. Таким образом, генерируемый код для битовых масок оказывается эффективнее и быстрее, чем при использовании битовых полей.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Также следует иметь в виду, что стандарт ANSI никак не определяет способ упаковки битовых полей в байт, так что, к примеру, один компилятор может поместить бит начиная со старшего MSB (Most Significant Bit), а другой компилятор начиная с младшего LSB (Least Significant Bit). С битовыми полями пользователь имеет полный контроль над расположением битов внутри переменной.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Доступ к памяти FLASH (память программ)</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обычно константа определяется следующим образом: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">const</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> max </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">127</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Эта константа копируется из памяти FLASH в память SRAM при запуске программы (когда подается питание на микроконтроллер), и остается в SRAM до завершения программы. Понятно, что это приводит к затратам памяти SRAM. Чтобы сохранить пространство в SRAM, константа может быть сохранена во FLASH, и загружена, когда это необходимо: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">flash </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> max </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">127</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">flash </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> string[] </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; background-color:#fff0f0;">&quot;Эта строка сохранена в памяти FLASH&quot;</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> flash </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">flashpointer;  </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Декларирование указателя на FLASH</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   flashpointer </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">&amp;</span><span style=" font-family:'Courier New,courier';">string[</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">0</span><span style=" font-family:'Courier New,courier';">]; </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Присваивание указателю адреса на место в памяти FLASH</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   UDR </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">flashpointer;       </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Чтение данных из FLASH и запись их в UART;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда строки сохранены во FLASH, как в этом последнем примере, они могут быть напрямую считаны из FLASH через указатели на память FLASH. Для компилятора C компании IAR C есть специальные библиотечные подпрограммы для обработки строк, подробнее см. руководство &quot;IAR compiler<br />users manual&quot;.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Управление выполнением кода</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Функция main</span>. Она обычно содержит главный цикл программы. В большинстве случаев нет функций, которые вызывают функцию main, так что нет необходимости резервировать какие-то регистры при входе в функцию main. Так что функция main может быть декларирована как C_task. Это сокращает место под стек, и уменьшает размер кода: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Циклы</span>. Бесконечные циклы, как ни странно, эффективнее делать с помощью for(;;) { }: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">for</span><span style=" font-family:'Courier New,courier';">(;;)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Тут тело цикла */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// ?0001:RJMP ?0001 ; Переход по метке</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Циклы do{ }while(выражение) обычно генерируют более эффективный код, чем while(выражение){ } и for{выражение1; выражение2; выражение3). В следующем примере показан код, генерируемый для цикла do{ }while: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> counter </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">100</span><span style=" font-family:'Courier New,courier';">; </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Декларирование переменной цикла */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// LDI R16,100 ; Инициализация переменной</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">do</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">} </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">while</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; color:#333333;">--</span><span style=" font-family:'Courier New,courier';">counter); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Декремент счетчика и проверка на 0 */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">//?0004: DEC R16 ; Декремент</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">// BRNE ?0004 ; Переход по метке, если не равно</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Переменные с преддекрементом в цикле обычно дают более эффективный код. Преддекремент и постинкремент более эффективен, потому что инструкции ветвления зависят от флагов после операции.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Что эффективнее - макросы или функции?</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ответ неоднозначен, и зависит от конкретных условий. Функции, которые ассемблируются в 3-4 строки ассемблерного кода или меньше, в некоторых случаях могут быть эффективнее реализованы в виде макроса. Когда используется макрос, то во время компиляции имя макроса в коде будет заменено на содержимое макроса. Для очень маленьких функций компилятор сгенерирует для макроса код меньшего размера, и он будет работать быстрее, чем вызов функции.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пример ниже показывает, как задача может быть выполнена с помощью функции и с помощью макроса. </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">/* Главная функция, которая вызывает другую функцию read_and_convert */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> C_task </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   UDR </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> read_and_convert(); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Чтение значения и отправка в UART */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">/* Функция, которая читает значение с вывода порта, </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;"> и преобразует его в код ASCII */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">char</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">read_and_convert</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">)</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">return</span><span style=" font-family:'Courier New,courier';"> (PINB </span><span style=" font-family:'Courier New,courier'; color:#333333;">+</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x48</span><span style=" font-family:'Courier New,courier';">); </span><span style=" font-family:'Courier New,courier'; color:#888888;">/* Возврат значения как символа ASCII */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#888888;">/* Макрос, который делает то же самое, что и read_and_convert */</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; color:#557799;">#define read_and_convert (PINB + 0x48)</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Код с вызовом функции будет ассемблирован в следующий код инструкций ассемблера: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#997700;">main:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">RCALL</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#996633;">read_and_convert</span><span style=" font-family:'Courier New,courier';">     </span><span style=" font-family:'Courier New,courier'; color:#888888;">; вызов функции</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">OUT</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#996633;">LOW</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">12</span><span style=" font-family:'Courier New,courier';">),</span><span style=" font-family:'Courier New,courier'; color:#996633;">R16</span><span style=" font-family:'Courier New,courier';">            </span><span style=" font-family:'Courier New,courier'; color:#888888;">; запись в I/O memory</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#997700;">read_and_convert:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">IN</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#996633;">R16</span><span style=" font-family:'Courier New,courier';">,</span><span style=" font-family:'Courier New,courier'; color:#996633;">LOW</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">22</span><span style=" font-family:'Courier New,courier';">)             </span><span style=" font-family:'Courier New,courier'; color:#888888;">; чтение I/O memory</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">SUBI</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#996633;">R16</span><span style=" font-family:'Courier New,courier';">,</span><span style=" font-family:'Courier New,courier'; color:#996633;">LOW</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">184</span><span style=" font-family:'Courier New,courier';">)          </span><span style=" font-family:'Courier New,courier'; color:#888888;">; добавить к значению 0x48</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">RET</span><span style=" font-family:'Courier New,courier';">                        </span><span style=" font-family:'Courier New,courier'; color:#888888;">; возврат из функции</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Код с макросом будет ассемблирован в следующий код инструкций ассемблера: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#997700;">main:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">IN</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#996633;">R16</span><span style=" font-family:'Courier New,courier';">,</span><span style=" font-family:'Courier New,courier'; color:#996633;">LOW</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">22</span><span style=" font-family:'Courier New,courier';">)             </span><span style=" font-family:'Courier New,courier'; color:#888888;">; чтение I/O memory</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">SUBI</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#996633;">R16</span><span style=" font-family:'Courier New,courier';">,</span><span style=" font-family:'Courier New,courier'; color:#996633;">LOW</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">184</span><span style=" font-family:'Courier New,courier';">)          </span><span style=" font-family:'Courier New,courier'; color:#888888;">; добавить к значению 0x48</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">      </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">OUT</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#996633;">LOW</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">12</span><span style=" font-family:'Courier New,courier';">),</span><span style=" font-family:'Courier New,courier'; color:#996633;">R16</span><span style=" font-family:'Courier New,courier';">            </span><span style=" font-family:'Courier New,courier'; color:#888888;">; запись в I/O memory</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Получается, что для функции размер кода 10 байт и время выполнения 10 циклов, а для макроса 6 байт и 3 цикла.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">18 советов по уменьшению размера кода</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">1</span>. Компилируйте с полной оптимизацией по размеру кода.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">2</span>. Везде, где это возможно, используйте локальные переменные.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">3</span>. Используйте самый маленький тип данных. Если можно, то используйте беззнаковый тип (unsigned).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">4</span>. Если нелокальная переменная используется только в пределах одной функции, то она должна быть определена в пределах этой функции с атрибутом static.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">5</span>. Собирайте нелокальные данные в структуры всякий раз, когда это выглядит естественным. Это увеличивает возможности по косвенной адресации без постоянной перезагрузки указателя.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">6</span>. Используйте указатели со смещением, или декларируйте структуры для доступа к memory mapped I/O;</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">7</span>. Для бесконечных циклов используйте for(;;) { }.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">8</span>. Используйте do { } while(expression), если это применимо.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">9</span>. Если это возможно, используйте в цикле счетчики на уменьшение и преддекремент.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">10</span>. Обращайтесь к I/O memory напрямую (например, не используйте указатели).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">11</span>. Если используются макросы _EEPUT/_EEGET, замените на EECR = ; с EECR |= ;.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">12</span>. Используйте битовые маски с типом unsigned char или unsigned int вместо битовых полей.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">13</span>. Декларируйте функцию main с атрибутом C_task, если она ниоткуда не вызывается в программе (обычно так и бывает).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">14</span>. Используйте вместо функций макросы, если функции ассемблируются в 2-3 строки кода ассемблера.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">15</span>. Уменьшите размер сегмента векторов прерываний (interrupt vector segment, INTVEC) до величины, которая действительно нужна для приложения. Альтернативно соедините все сегменты CODE в одну декларацию, и это будет сделано автоматически.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">16</span>. Используйте внутримодульное повторное применение функций. Собирайте несколько функций в одном модуле (т. е. в одном файле) для увеличения фактора повторного использования кода.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">17</span>. В некоторых случаях полная оптимизация по скорости приводит к большей экономии кода, чем полная оптимизация по размеру. Компилируйте проект помодульно, чтобы исследовать - что дает самый лучший результат.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">18</span>. Оптимизируйте C_startup так, чтобы не инициализирвоать неиспользуемые сегменты (например IDATA0 или IDATA1, если все переменные tiny или small).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">5 советов по уменьшению требований к RAM</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">1</span>. Все константы и литералы должны быть размещены в памяти FLASH с использованием ключевого слово flash.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">2</span>. Избегайте использования глобальных переменных, если можно использовать локальные. Это также уменьшает размер кода. Локальные переменные выделяются динамически из стека, и удаляются оттуда, когда функция теряет управление (произведен выход из функции).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">3</span>. Если используются большие функции с переменными, имеющий ограниченное время жизни, может быть выгодным использование subscope-переменных.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">4</span>. Хорошую оценку размера кода и стека можно получить из выходного файла статистики линкера (так называемый MAP-файл).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">5</span>. Не тратьте пространство памяти на сегменты IDATA0 и UDATA0 за исключением случаев, когда используете переменные tiny (см. файл линкера).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Контрольный список для отладки программ</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">1</span>. Удостоверьтесь, что сегмент CSTACK достаточного размера.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">2</span>. Удостоверьтесь, что сегмент RSTACK достаточного размера.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">3</span>. Удостоверьтесь, что интерфейс к внешней памяти разрешен, когда он должен быть включен, и запрещен, когда он должен быть выключен.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">4</span>. Если обычная функция и обработчик прерывания обмениваются данными через глобальную переменную, то эта переменная должна быть объявлена с атрибутом volatile - чтобы гарантировать, что она считывается из RAM каждый раз, когда должна быть проверена.</p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>