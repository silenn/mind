<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Georgia'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">В системе FreeRTOS каждый поток выполнения называется 'задачей' (task). Нет абсолютного согласия в терминологии по компонентам внутри встраиваемых систем, но наверное предпочтительнее использовать вместо термина 'поток' (thread) термин 'задача' (task), поскольку thread (поток) может иметь более специфичное значение в зависимости от внешних ранее приобретенных знаний.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#000000; background-color:#ffffff;">1.2 Функции задачи</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Задачи реализованы как функции на языке C. Есть только одна особенность в прототипе такой функции - она должна возвращать void и принимать в качестве параметра указатель на void</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff; background-color:#ffffff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"> ATaskFunction( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff; background-color:#ffffff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"> *pvParameters );</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Каждая задача - это маленькая программа со своими собственными правами. Она имеет точку входа, нормально выполняет свой бесконечный цикл, из которого никогда не делает выход. Структура типичной задачи показана в листинге 2.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Задачи FreeRTOS не должны никоим образом делать возврат (выход) из своей функции - она не должна содержать оператор 'return', и выполнению не должно быть позволено доходить до конца функции. Если в функции больше нет надобности, вместо выхода из неё нужно явно удалить запущенную задачу. Это также демонстрируется в листинге 2.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Один и тот же код функции может использоваться для запуска любого количества одинаковых задач - каждая созданная задача имеет индивидуальную среду выполнения с собственным стеком и собственной копией любых автоматических (стековых) переменных, определенных в теле задачи.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff; background-color:#ffffff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"> ATaskFunction( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff; background-color:#ffffff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000; background-color:#ffffff;">   /* Переменные могут быть определены точно так же, как и в обычной функции.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000; background-color:#ffffff;">      Каждый экземпляр созданной по этой функции задачи будет иметь собственную копию</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000; background-color:#ffffff;">      переменной iVariableExample. Это не верно, если переменная была продекларирована</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000; background-color:#ffffff;">      как статическая (static) – в этом случае будет сущесвовать только одна копия</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000; background-color:#ffffff;">      переменной, и она будет использоваться совместно всеми созданными экземплярами<br />      задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff; background-color:#ffffff;">   int</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"> iVariableExample = 0;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000; background-color:#ffffff;">/* Задача должна быть нормально реализована как бесконечный цикл. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff; background-color:#ffffff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000; background-color:#ffffff;">/* Код, который реализует функционал задачи, должен быть помещен здесь. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"><br />  }<br /><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000; background-color:#ffffff;">   /* Код должен быть организован так, чтобы в случае выхода (break) из указанного</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000; background-color:#ffffff;">      выше бесконечного цикла задачи, задача должна быть удалена ПРЕЖДЕ чем</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000; background-color:#ffffff;">      управление достигнет конца этой функции. Параметр NULL, переданный<br />      vTaskDelete(), показывает, что должна быть удалена вызванная (эта, которая<br />      работает) задача. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"><br />   vTaskDelete( NULL );<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Листинг 2. Структура типичной функции задачи</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#000000; background-color:#ffffff;">1.3 Состояния задачи на верхнем уровне</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Приложение может состоять из множества задач. Если микроконтроллер, выполняющий приложение, имеет только одно ядро (так бывает в большинстве малых встраиваемых систем), то в каждый момент времени может выполняться только какая-то одна задача. Это означает, что любая задача может находиться в одном из двух возможных состояний - запущена (</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#000000;">Running</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;">) и не запущена (</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#000000;">Not Running</span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;">). Пока мы примем такое упрощение, однако надо иметь в виду, что на самом деле состояние Not Running имеет несколько разновидностей - подсостояний (это мы рассмотрим далее).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">когда задача находится в состоянии Running, то процессор в настоящий момент выполняет её код. Когда задача находится в состоянии Not Running, то задача находится в бездействии, её текущий статус сохранен в готовности продолжить выполнение, как только шедулер примет решение перевести задачу в состояние Running. Когда задача продолжает выполнение, она начнет работу именно с той инструкции, где выполнение было прервано при выходе задачи из последнего состояния Running.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">О задаче, переходящей из состояния Not Running в состояние Running, говорят, что она &quot;подключилась&quot; (&quot;switched in&quot; или &quot;swapped in&quot;). И аналогично, о задаче, переходящей из состояния Running в состояние Not Running говорят, что она &quot;отключилась&quot; (&quot;switched out&quot; или &quot;swapped out&quot;). Шедулер FreeRTOS - всего лишь некая сущность, которая может включить (in) и выключить (out) задачу.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#000000; background-color:#ffffff;">1.4 Создание задач</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">API функция <span style=" font-weight:600;">xTaskCreate() </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задачи создаются с использованием API функции xTaskCreate(). Очень важен тот факт, что задачи должны быть предварительно специальным образом подготовлены, чтобы стать фундаментальным компонентом многозадачной системы. Все примеры, приведенные в этой книге, используют для создания задач функцию xTaskCreate().</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В Дополнении 5 описываются типы данных и используемые условные соглашения по именованию типов данных и функций.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; font-weight:600; color:#000000;">portBASE_TYPE xTaskCreate( pdTASK_CODE pvTaskCode,<br />                           </span><span style=" font-family:'Courier New'; font-size:10pt; font-weight:600; color:#0000ff;">const</span><span style=" font-family:'Courier New'; font-size:10pt; font-weight:600; color:#000000;"> signed portCHAR * </span><span style=" font-family:'Courier New'; font-size:10pt; font-weight:600; color:#0000ff;">const</span><span style=" font-family:'Courier New'; font-size:10pt; font-weight:600; color:#000000;"> pcName,<br />                           unsigned portSHORT usStackDepth,<br />                           </span><span style=" font-family:'Courier New'; font-size:10pt; font-weight:600; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; font-weight:600; color:#000000;"> *pvParameters,<br />                           unsigned portBASE_TYPE uxPriority,<br />                           xTaskHandle *pxCreatedTask );</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Прототип API функции xTaskCreate().</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">   </span>Имя параметра, возвращаемое значение и описание:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">pvTaskCode</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задачи - это простые C-функции, которые никогда не делают возврата из своего тела (постоянно выполняют свой бесконечный цикл). Параметр pvTaskCode - простой указатель на функцию (т. е. просто имя функции), которая реализует задачу.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">pcName</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Описательное имя для задачи. Оно никак не используется внутри FreeRTOS, и нужно только для целей отладки. Идентификация задачи по легкочитаемому имени намного проще, чем по хендлу задачи (handle).<br /><br />В приложении указана константа времени компиляции <span style=" font-weight:600;">configMAX_TASK_NAME_LEN</span>, которая задает максимальную длину для этого имени - включая нулевой байт окончания строки. Если в качестве pcName предоставлена более длинная строка, то она молча урезается до величины, заданной configMAX_TASK_NAME_LEN.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">usStackDepth</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Каждая задача имеет собственное уникальное хранилище состояния, выделенное ядром при создании задачи. Значение параметра usStackDepth говорит ядру, какой величины стек необходимо создать.<br /><br />Значение usStackDepth указывает количество слов, которое можно сохранить в стеке, а не количество байт. Например, если стек имеет ширину 32 бита, и переданное значение usStackDepth равно 100, то под стек будет выделено 400 байт (100 * 4 байт). Глубина стека, умноженная на его ширину, не должна превышать максимальное значение, которое может содержать переменная типа size_t.<br /><br />Размер стека, используемого для задачи ожидания (idle task, об этой задаче подробнее говорится далее), задается константой configMINIMAL_STACK_SIZE. Значение, назначенное этой константе в демо-приложении FreeRTOS (для определенной архитектуры микроконтроллера) может быть использовано как минимально рекомендованное для любой задачи. Если Ваша программа использует пространство в стеке, то нужно указать для константы configMINIMAL_STACK_SIZE увеличенное значение.<br /><br />Нет простого способа узнать, какого размера стек нужен для задачи. Этот размер можно вычислить, но в большинстве случаев можно просто назначить подходящее значение, подобранное опытным путем, либо взятое приблизительно. Подобрать правильный размер стека важно, чтобы обеспечить адекватное использование RAM без ненужных затрат. Часть 6 содержит информацию о том, как запросить размер стека, используемого задачей.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">pvParameters</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функции задач принимают параметр, имеющий тип указателя на void (т. е. void*). Значение, указанное в pvParameters, будет передано в задачу. Несколько примеров в этом документе демонстрируют, как этот параметр может быть использован в реальных задачах.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">uxPriority</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задает приоритет, с которым будет выполняться задача. Приоритеты могут быть назначены в любое значение от 0 минимальный приоритет до (configMAX_PRIORITIES – 1) максимальный приоритет.<br /><br />Константа configMAX_PRIORITIES определяется пользователем. Нет ограничения на верхний предел для количества приоритетов, которые можно задать (кроме ограничения на лимит используемого типа данных ограничения по количеству RAM, доступному в микроконтроллере), но желательно использовать как можно меньшее количество приоритетов, которое действительно необходимо - с целью уменьшения расхода RAM.<br /><br />Передача в параметре значения uxPriority выше (configMAX_PRIORITIES – 1) приведет к молчаливому назначению приоритета задачи в максимально допустимое значение configMAX_PRIORITIES.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">pxCreatedTask</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Параметр pxCreatedTask может использоваться для передачи наружу хендла созданной задачи. Этот хендл можно использовать как ссылку на задачу в вызовах API FreeRTOS, например для изменения приоритета задачи или для удаления задачи.<br /><br />Если Ваше приложение не использует хендл задачи, то pxCreatedTask может быть установлен в NULL.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Возвращаемое значение</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Имеется два возможных возвращаемых значения:<br /><br /><span style=" font-weight:600;">1</span>. pdTRUE показывает, что задача успешно создана.<br /><span style=" font-weight:600;">2</span>. errCOULD_NOT_ALLOCATE_REQUIRED_MEMORY показывает, что задача не создана, так как в куче (heap) недостаточно свободной памяти для FreeRTOS, чтобы она могла выделить место для структур данных задачи и стека. Часть 5 предоставляет больше информации по управлению памятью.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Пример 1. Создание задачи</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Дополнение 1 содержит информацию об инструментарии, необходимом для сборки проектов примеров. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Этот пример демонстрирует необходимые шаги для создания двух простых задач и для последующего запуска этих задач на выполнение. Задачи просто периодически выводят на печать строку, используя грубый пустой цикл для создания задержки. Обе задачи создаются с одинаковым приоритетом и абсолютно идентичны, отличаясь только строками, которые они выводят - см. Листинг 4 и Листинг 5 для их соответствующих реализаций.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 4. Реализация первой задачи, используемой в примере 1.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTask1( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">const</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTaskName = </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 1 is running\r\n&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">;<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">volatile</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> unsigned </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">long</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> ul;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Как и большинство задач, эта задача реализована на основе бесконечного цикла. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Вывод на печать имени этой задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( pcTaskName );<br /><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задержка на некоторый период времени. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ul = 0; ul &lt; mainDELAY_LOOP_COUNT; ul++ )<br />     {<br />         </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Этот цикл просто реализует задержку очень грубым методом.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            В цикле не производится никаких действий. Далее будут приведены</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            примеры, в которых этот пустой цикл будет заменен соответствующей</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            функцией задержки / приостановки задачи (введение задачи в состояние</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            сна - sleep). */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     }<br />  }<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 5. Реализация второй задачи, используемой в примере 1.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTask2( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">const</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTaskName = </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 2 is running\r\n&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">;<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">volatile</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> unsigned </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">long</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> ul;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Как и большинство задач, эта задача реализована на основе бесконечного цикла. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Вывод на печать имени этой задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( pcTaskName );<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задержка на некоторый период времени. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ul = 0; ul &lt; mainDELAY_LOOP_COUNT; ul++ )<br />     {<br />         </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Этот цикл просто реализует задержку очень грубым методом. </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            В цикле не производится никаких действий. Далее будут приведены</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            примеры, в которых этот пустой цикл будет заменен соответствующей</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            функцией задержки / приостановки задачи (введение задачи в состояние</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            сна - sleep). */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     }<br />  }<br />}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функция main() просто создает задачи перед запуском шедулера - см. Листинг 6.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 6. Запуск задач примера 1.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">int</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> main( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> )<br />{<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Создание одной из двух задач. Имейте в виду, что реальное приложение должно</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     проверить возвращаемое значение из вызова xTaskCreate(), чтобы удостовериться,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     что задача была успешно создана. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xTaskCreate( vTask1,  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Указатель на функцию, которая реализует задачу. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />               </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 1&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Текстовое имя задачи. Этот параметр нужен только для</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">                           упрощения отладки. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />               1000,    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Глубина стека - самые маленькие микроконтроллеры будут</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">                           использовать значение намного меньше, чем здесь<br />                           указано. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />               NULL,    </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Мы не используем параметр задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />               1,       </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задача будет запущена с приоритетом 1. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />               NULL );  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Мы не будем использовать хендл задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Создание другой задачи полностью совпадает с созданием первой, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     приоритет задачи тот же. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xTaskCreate( vTask2, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">, 1000, NULL, 1, NULL );<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Запуск шедулера, после чего задачи запустятся на выполнение. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  vTaskStartScheduler();<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Если все хорошо, то управление в main() никогда не дойдет до этой точки,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     и теперь шедулер будет управлять задачами. Если main() довела управление<br />     до этого места, то это может означать, что не хватает памяти кучи</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     (heap) для создания специальной задачи ожидания (idle task, об этой задаче</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     далее). Часть 5 предоставляет больше информации по управлению памятью. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; );<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Выполнение примера 1 производит вывод, показанный на рисунке 2.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image11272.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 2. Вывод, который производит при выполнении пример 1.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На рисунке 2 видно, что две задачи работают вместе, но поскольку они обе выполняются на одном процессоре, то реально все происходит несколько иначе. В действительности обе задачи быстро входят в состояние Running (запущено) и быстро выходят из него. Обе задачи работают с одинаковым приоритетом, и делят между собой процессорное время. Диаграмма реального процесса выполнения показана на рисунке 3.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image4791.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 3. Реальный паттерн выполнения двух задач примера 1.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пример 1 создает обе задачи в теле функции main() перед запуском шедулера. Также есть возможность создания задачи из кода другой задачи. В другом примере мы создаем задачу 1 из кода функции main(), и затем создаем задачу 2 из кода задачи 1. Для того, чтобы сделать это, нужно ввести изменения, как показано в листинге 7. Задача 2 не будет создана, пока не запустится шедулер, однако вывод, генерируемый измененным примером, должен быть таким же.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 7. Создание задачи из кода другой задачи - после того, как шедулер уже стартовал.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTask1( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">const</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTaskName = </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 1 is running\r\n&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">;<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">volatile</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> unsigned </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">long</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> ul;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Если этот код выполняется, то шедулер уже запустился. Создаем</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     здесь другую задачу перед входом в бесконечный цикл. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     xTaskCreate( vTask2, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">, 1000, NULL, 1, NULL );<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Вывод на печать имени этой задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( pcTaskName );<br /><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задержка на некоторый период времени. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ul = 0; ul &lt; mainDELAY_LOOP_COUNT; ul++ )<br />     {<br />         </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Этот цикл просто реализует задержку очень грубым методом. </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            В цикле не производится никаких действий. Далее будут приведены</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            примеры, в которых этот пустой цикл будет заменен соответствующей</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            функцией задержки / приостановки задачи (введение задачи в состояние</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            сна - sleep). */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     }<br />  }<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Пример 2. Использование параметра задачи </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Две задачи, созданные в примере 1, почти одинаковы, отличаясь только текстом, который они выводят на печать. Дублирование кода может быть устранено простым созданием двух экземпляров одной и той же задачи. В этом случае параметр задачи можно использовать, чтобы передать каждой задаче отдельную строку для вывода.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 8 содержит код единой функции для всех задач (vTaskFunction), используемых в примере 2. Одиночная функция заменяет две функции задачи (vTask1 и vTask2), используемые в примере 1. Посмотрим, как параметр задачи преобразуется в тип char* для получения строки, которую нужно вывести на печать.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 8. Одна функция задачи, используемая для создания двух задач примера 2.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTaskFunction( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTaskName;<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">volatile</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> unsigned </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">long</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> ul;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Строка для вывода на печать передается через параметр. Здесь</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     он преобразуется в указатель на символьную строку. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  pcTaskName = ( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> * ) pvParameters;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Как и большинство задач, эта задача реализована на основе бесконечного цикла. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Вывод на печать имени этой задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( pcTaskName );<br /><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задержка на некоторый период времени. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ul = 0; ul &lt; mainDELAY_LOOP_COUNT; ul++ )<br />     {<br />         </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Этот цикл просто реализует задержку очень грубым методом. </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            В цикле не производится никаких действий. Далее будут приведены</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            примеры, в которых этот пустой цикл будет заменен соответствующей</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            функцией задержки / приостановки задачи (введение задачи в состояние</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">            сна - sleep). */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     }<br />  }<br />}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Несмотря на то, что теперь реализация задач только одна (vTaskFunction), можно задать бОльшее, чем один, количество экземпляров задачи, Каждый созданный экземпляр задачи будет выполняться независимо от другого под управлением шедулера FreeRTOS.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Параметр <span style=" font-weight:600;">pvParameters</span>, передаваемый в функцию xTaskCreate(), используется для передачи строки текста, как показано в листинге 9.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 9. Функция main() для примера 2.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Определение строк, которые будут переданы через параметры задачи. Они определены</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">  как константы (const) и не находятся в стеке, чтобы обеспечить их сохранность,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">  когда задачи выполняются. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">static</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">const</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTextForTask1 = “Task 1 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">is</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> running\r\n”;<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">static</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">const</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTextForTask2 = “Task 2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">is</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> running\t\n”;<br /><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">int</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> main( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> )<br />{<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Создание одной из двух задач. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xTaskCreate( vTaskFunction, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Указатель на функцию, которая реализует</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">                                 задачу. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />               </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 1&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">,      </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Текстовое имя задачи. Используется только</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">                                 для упрощения отладки. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />               1000,          </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Глубина стека - самые маленькие микроконтроллеры</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">                                 будут использовать значение намного меньше,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">                                 чем здесь указано. */</span><br /><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">              (</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">*)pcTextForTask1, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Передача печатаемого задачей текста как</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">                                        параметр задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />               1,              </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задача будет запущена с приоритетом 1. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />               NULL );         </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Мы не будем использовать хендл задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Создание другой задачи происходит точно так же. Обратите внимание, что несколько</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     задач создается из ОДНОЙ И ТОЙ ЖЕ реализации задачи (vTaskFunction). Различие</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     только в величине параметра, переданного для вывода строки. Создается два</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     экземпляра одной и той же задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xTaskCreate( vTaskFunction, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">, 1000, (</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">*)pcTextForTask2, 1, NULL );<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Запуск шедулера, чтобы наши задачи смогли выполняться. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  vTaskStartScheduler();<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Если все хорошо, то управление в main() никогда не дойдет до этой точки,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     и теперь шедулер будет управлять задачами. Если main() довела управление до </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     этого места, то это может означать, что не хватает памяти кучи (heap)</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     для создания специальной задачи ожидания (idle task, об этой задаче далее).</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     Часть 5 предоставляет больше информации по управлению памятью. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; );<br />}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вывод, производимый примером 2, абсолютно такой же, как в примере 1 (показано на рисунке 2).</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">1.5. Приоритеты задачи</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Параметр <span style=" font-weight:600;">uxPriority</span> API функции xTaskCreate() назначает начальный приоритет для создаваемой задачи. Приоритет может быть изменен после запуска шедулера при помощи API функции <span style=" font-weight:600;">vTaskPrioritySet</span>().</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Максимально возможное количество доступных приоритетов задается в приложении константой времени компиляции <span style=" font-weight:600;">configMAX_PRIORITIES</span> в файле <span style=" font-weight:600;">FreeRTOSConfig.h</span>. Система FreeRTOS сама по себе не ограничивает максимально возможное значение для этой константы, однако нужно помнить, что чем больше значение configMAX_PRIORITIES, тем больше потребляется ядром памяти RAM, поэтому рекомендуется всегда устанавливать эту константу на минимально возможное значение.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">FreeRTOS не накладывает никаких ограничений на то, как приоритеты могут быть назначены задачам. Любое количество задач могут иметь одинаковый приоритет, что предоставляет максимум гибкости для разработки приложения. Вы можете назначить уникальный приоритет каждой задаче, если это необходимо (в соответствии с требованиями некоторых алгоритмов, использующих шедулинг), и в этом тоже нет никаких ограничений.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Значения приоритетов, имеющих малую числовую величину, предназначены для низкоприоритетных задач, значение 0 соответствует самому низкому возможному приоритету. Таким образом, диапазон возможных приоритетов лежит от 0 до (configMAX_PRIORITIES – 1).</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Шедулер всегда предоставляет возможность запуститься для задачи с наивысшим приоритетом и войти для неё в состояние Running. Когда несколько задач имеют одинаковый приоритет, и они могут быть запущены, то шедулер будет переводить каждую из этих задач в состояние Running и обратно по очереди в цикле. Это поведение было показано в недавних примерах, где обе тестовые задачи были созданы с одинаковым приоритетом, и обе всегда могли быть запущены. Каждая из этих задач выполнялась в фиксированном интервале времени, так называемом &quot;слайсе времени&quot; (&quot;<span style=" font-weight:600;">time slice</span>&quot;, далее этот интервал будем называть просто &quot;слайс&quot;), когда задача входит в режим Running на начале слайса и выходит из режима Running в конце этого слайса и в начале следующего. На рисунке 3 интервал времени между t1 и t2 равен одному слайсу времени.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы шедулер мог определить - какую задачу нужно в начале каждого слайса, шедулер сам запускается на выполнение в конце каждого слайса времени. Для этой цели используются периодическое прерывание, называемое тиком (<span style=" font-weight:600;">tick interrupt</span>). Продолжительность слайса времени устанавливается по частоте срабатывания прерываний (тиков), которая конфигурируется константой времени компиляции <span style=" font-weight:600;">configTICK_RATE_HZ</span> в файле FreeRTOSConfig.h. Например, если configTICK_RATE_HZ установлена в 100 (Гц), то длительность слайса составит 10 мс. Рисунок 3 может быть расширен, чтобы показать также работу и самого шедулера во всей последовательности выполнения задач. Это показано на рисунке 4.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Имейте в виду, что вызовы API функций FreeRTOS всегда указывают время в тиках прерываний (обычно их просто называют 'тики', 'ticks'). Константа <span style=" font-weight:600;">portTICK_RATE_MS</span> предоставлена для того, чтобы можно было преобразовать интервал времени в тиках в интервал времени в миллисекундах. Доступная разрешающая способность зависит от частоты тиков.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Значение счетчика тиков 'tick count' равно количеству произошедших прерываний тиков с момента старта шедулера; предполагается, что в счетчике тиков не было переполнения. Приложения пользователя не должны отслеживать переполнения при указании периода задержки, так как целостность отсчета времени обеспечивается внутри ядра FreeRTOS.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image16239.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 4. Последовательность выполнения, расширенная, чтобы показать выполнение прерывания тиков.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На рисунке 4 красной линией показано, когда выполняется само ядро (обработчик прерывания тиков). Черные стрелки показывают последовательность выполнения от задачи до прерывания, и затем обратно от прерывания к другой задаче.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Пример 3. Экспериментирование с приоритетами</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как уже говорилось, шедулер всегда обеспечивает для задачи с наивысшим приоритетом возможность запуска при выборе задачи для входа в состояние Running. В наших недавних примерах были созданы две задачи с одинаковым приоритетом, так они входили по циклу в состояние Running и выходили из него по очереди. Этот пример рассматривает что произойдет, когда мы изменим приоритет одной из двух задач, созданных в примере 2. Это произойдет, когда первая задача будет создана с приоритетом 1, а вторая задача с приоритетом 2. Код для создания задач показан в листинге 10. Одиночная функция, которая используется для реализации обоих задач, остается неизменной, она просто периодически выводит на печать строку, используя пустой цикл для организации задержки.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 10. Создание двух задач с разными приоритетами.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Определение строк, которые будут переданы через параметры задачи. Они определены</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">  как константы (const) и не находятся в стеке, чтобы обеспечить их сохранность,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">  когда задачи выполняются. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">static</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">const</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTextForTask1 = “Task 1 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">is</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> running\r\n”;<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">static</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">const</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTextForTask2 = “Task 2 </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">is</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> running\t\n”;<br /><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">int</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> main( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> )<br />{<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Создание первой задачи с приоритетом 1. Приоритет - предпоследний</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     параметр. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xTaskCreate( vTaskFunction, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 1&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">, 1000, (</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">*)pcTextForTask1, 1, NULL );<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Создание второй задачи с приоритетом 2. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xTaskCreate( vTaskFunction, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">, 1000, (</span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">*)pcTextForTask2, 2, NULL );<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Запуск шедулера, чтобы наши задачи смогли выполняться. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  vTaskStartScheduler();<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">return</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> 0;<br />}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вывод, производимый примером 3, показан на рисунке 5. Шедулер всегда будет выбирать для запуска задачу с наивысшим приоритетом. Задача 2 имеет приоритет выше, чем у задачи 1, и задача 2 всегда допустима для запуска; поэтому только задача 2 всегда входит в режим Running. Так как задача 1 никогда не входит в режим Running, то она не выводит строк на печать. О задаче 1 говорят как о 'зависшей', поскольку задача 2 не дает ей свободного процессорного времени.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image7494.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 5. Запуск обоих тестовых задач с разными приоритетами.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задача 2 всегда готова к запуску, потому что она никогда не ждет какого-то события - она либо крутится в пустом цикле, либо печатает вывод строки на терминал.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рисунок 6 показывает последовательность выполнения примера 3.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image8929.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 6. Диаграмма выполнения, когда одна задача имеет более высокий приоритет, чем другая.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">1.6. Что означает состояние задачи ‘NOT RUNNING’ (не запущено)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В прошлых примерах каждая создаваемая задача всегда нуждалась в каких-то действиях (пусть даже пустых в виде цикла задержки), и в них никогда не нужно было ожидать чего-либо. Поскольку такие задачи не ожидают никаких событий, то они всегда были готовы войти в состояние Running. Такой тип задачи с продолжающейся обработкой имеет ограниченное применение, потому что такую задачу можно создать только с самым низким приоритетом. Если же такая задача будет запущена не с самым низким приоритетом, то она не даст запуститься задачам с более низким приоритетом.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы сделать Ваши задачи в приложении действительно полезными, нам нужен метод, который позволит управлять задачей по событию. Задача, управляемая событием, запускается в работу (делает обработку) только после возникновения переключающего состояние задачи события, и такая задача не может войти в состояние Running, пока такое событие не произойдет. Как уже говорилось, шедулер всегда выбирает для запуска задачу с наивысшим приоритетом, которая МОЖЕТ запуститься. То, что высокоприоритетные задачи в настоящий момент НЕ МОГУТ запуститься означает, что шедулер их пока не может выбрать и должен вместо этого выбрать одну из задач с более низким приоритетом. Таким образом, использование управляемых событиями задач означает, что задачи могут быть созданы с некоторыми разными приоритетами, причем высокоуровневые задачи не будут полностью отнимать процессорное время у низкоуровневых.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Состояние Blocked</span> (заблокировано)</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Говорят, что ожидающая событие задача находится в состоянии Заблокировано (Blocked state), которое является подсостоянием состояния Not Running.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задачи могут войти в Blocked state для ожидания событий двух разных типов:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">1. События времени - событие, которое возникает при истечении периода задержки или при достижении абсолютного времени. Например, задача может войти в Blocked state для ожидания прохождения 10 миллисекунд времени.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2. События синхронизации - событие, поступившее от другой задачи или от прерывания. Например, задача может войти в Blocked state для ожидания поступления данных (появления их в очереди). События синхронизации покрывают широкий диапазон типов событий.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Во FreeRTOS могут использоваться очереди, двоичные семафоры, семафоры со счетчиком, рекурсивные семафоры, мьютексы - для создания событий синхронизации. Части 2 и 3 рассматривают это более подробно.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Можно устроить для задачи событие синхронизации с таймаутом, и эффективно обрабатывать оба типа событий (события времени и синхронизации). Например, задача может ожидать максимум 10 миллисекунд события появления данных в очереди. Задача покинет состояние Blocked state либо при поступлении данных на очереди, либо по истечении 10 миллисекунд (что означает таймаут поступления данных).</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Состояние Suspended</span> (приостановлено)</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Suspended также является подсостоянием состояния Not Running. Задачи в состоянии suspended недоступны для шедулера. Есть только один способ входа в состояние Suspended - через вызов API функции vTaskSuspend(), и только один способ выхода из состояния Suspended - через вызов API функции vTaskResume() или (если вызов происходит из прерывания) xTaskResumeFromISR(). Большинство приложений никогда не используют состояние Suspended.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> vTaskSuspend</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> xTaskHandle pxTaskToSuspend </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы функция vTaskSuspend была доступна, нужно включить заголовочный файл task.h, и задать макроопределение INCLUDE_vTaskSuspend в значение 1. Функция vTaskSuspend приостанавливает задачу, переводя её в состояние Suspended, освобождая тем самым процессорное время для других задач. Вызовы vTaskSuspend не аккумулятивны, то есть вызов vTaskSuspend дважды для той же самой задачи все равно требует однократного вызова vTaskResume() для возобновления этой приостановленной задачи. Параметр pxTaskToSuspend передает хендл задачи, которая должна быть приостановлена. Если передать в качестве параметра NULL, то будет приостановлена вызывающая задача (т. е. если задача вызовет vTaskSuspend с параметром NULL, то она приостановит саму себя). Пример использования:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> vAFunction</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#009900;">)<br />{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   xTaskHandle xHandle</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Создание задачи, сохранение значения хендла.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   xTaskCreate</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> vTaskCode</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#ff0000;">&quot;NAME&quot;</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> STACK_SIZE</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> NULL</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> tskIDLE_PRIORITY</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#339933;">&amp;</span><span style=" font-family:'monospace';">xHandle </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// ...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Использование хендла для приостановки созданной задачи.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   vTaskSuspend</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> xHandle </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// ...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Созданная задача не будет работать в это время, за исключением случаев,</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// когда другая задача вызовет vTaskResume( xHandle ).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">//...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Приостановка задачей самой себя.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   vTaskSuspend</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> NULL </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Мы не сможем попасть в эту точку кода, пока другая задача не вызовет</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// vTaskResume с хендлом этой задачи в качестве параметра.<br /></span><span style=" font-family:'monospace'; color:#009900;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Таким образом, если задача находится в состоянии Suspended (приостановлено), то вывести из этого состояния может только вызов функции vTaskResume.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> vTaskResume</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> xTaskHandle pxTaskToResume </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы функция vTaskResume была доступна для использования в коде программы, нужно подключить заголовочный файл task.h и определить макро INCLUDE_vTaskSuspend в значение 1. В качестве параметра передается хендл возобновляемой задачи. После вызова vTaskResume задача переводится в состояние Ready (готова к запуску), т. е. выполнение задачи будет возобновлено шедулером. Пример использования:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> vAFunction</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#009900;">)<br />{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   xTaskHandle xHandle</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Создание задачи, сохранение хендла.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   xTaskCreate</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> vTaskCode</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#ff0000;">&quot;NAME&quot;</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> STACK_SIZE</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> NULL</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> tskIDLE_PRIORITY</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#339933;">&amp;</span><span style=" font-family:'monospace';">xHandle </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// ...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Использование этого хендла для приостановки созданной задачи.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   vTaskSuspend</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> xHandle </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// ...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Созданная задача не будет работать в течение этого периода, пока </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// другая задача не вызовет vTaskResume( xHandle ).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">//...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Самостоятельное возобновление приостановленной задачи.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   vTaskResume</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> xHandle </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Созданная задача еще раз получит процессорное время микроконтроллера</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// в соответствии с назначенным приоритетом в системе.<br /></span><span style=" font-family:'monospace'; color:#009900;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для возобновления функций из тела обработчика прерывания (ISR) служит функция xTaskResumeFromISR.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">portBASE_TYPE xTaskResumeFromISR</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> xTaskHandle pxTaskToResume </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы функция xTaskResumeFromISR была доступна для использования в коде программы, нужно подключить заголовочный файл task.h и определить макросы INCLUDE_vTaskSuspend и INCLUDE_xTaskResumeFromISR в значение 1. Подробности см. в секции конфигурирования FreeRTOS. В качестве параметра передается хендл возобновляемой задачи.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функция xTaskResumeFromISR() не должна использоваться в целях синхронизации задачи с прерыванием, если есть шанс, что задача еще не была остановлена, так как такая ситуация может привести к пропуску прерываний. Использование семафора для синхронизации позволит обойти эту проблему.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На выходе функция xTaskResumeFromISR возвратит pdTRUE, если возобновление задачи должно произойти при переключении контекста, иначе будет возвращено pdFALSE. Это используется обработчиком прерывания, чтобы определить, нужно ли делать переключение контекста после завершения ISR. Пример использования:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">xTaskHandle xHandle</span><span style=" font-family:'monospace'; color:#339933;">;</span><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> vAFunction</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#009900;">)<br />{<br /></span><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Создание задачи, сохранение хендла.<br /></span><span style=" font-family:'monospace';">   xTaskCreate</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> vTaskCode</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#ff0000;">&quot;NAME&quot;</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> STACK_SIZE</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> NULL</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> tskIDLE_PRIORITY</span><span style=" font-family:'monospace'; color:#339933;">,</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#339933;">&amp;</span><span style=" font-family:'monospace';">xHandle </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// ... остальная часть кода.<br /></span><span style=" font-family:'monospace'; color:#009900;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> <br /></span><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> vTaskCode</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#339933;">*</span><span style=" font-family:'monospace';">pvParameters </span><span style=" font-family:'monospace'; color:#009900;">)<br />{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Задача, которая приостановлена и возобновлена.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; color:#b1b100;">for</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#339933;">;;</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#009900;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; color:#009900;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">     </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// ... здесь выполните некоторую функцию.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">     </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Эта задача приостанавливает сама себя.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">     vTaskSuspend</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> NULL </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">     </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Задача теперь приостановлена, так что в это место управление не дойдет,<br />     // пока ISR не возобновит эту задачу.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; color:#009900;">}<br />}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> vAnExampleISR</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#993333;">void</span><span style=" font-family:'monospace';"> </span><span style=" font-family:'monospace'; color:#009900;">)<br />{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   portBASE_TYPE xYieldRequired</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Возобновление приостановленной задачи.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   xYieldRequired </span><span style=" font-family:'monospace'; color:#339933;">=</span><span style=" font-family:'monospace';"> xTaskResumeFromISR</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> xHandle </span><span style=" font-family:'monospace'; color:#009900;">)</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; color:#b1b100;">if</span><span style=" font-family:'monospace'; color:#009900;">(</span><span style=" font-family:'monospace';"> xYieldRequired </span><span style=" font-family:'monospace'; color:#339933;">==</span><span style=" font-family:'monospace';"> pdTRUE </span><span style=" font-family:'monospace'; color:#009900;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; color:#009900;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">      </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Мы должны переключить контекст, поэтому ISR вернет управление<br />      // в другую задачу.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">      </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// Примечание: как это будет осуществлено, зависит от порта FreeRTOS,<br />      // который Вы используете. Для получения информации ознакомьтесь</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">      </span><span style=" font-family:'monospace'; font-style:italic; color:#666666;">// с документацией на Ваш порт.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">      portYIELD_FROM_ISR</span><span style=" font-family:'monospace'; color:#009900;">()</span><span style=" font-family:'monospace'; color:#339933;">;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';">   </span><span style=" font-family:'monospace'; color:#009900;">}<br />}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Состояние Ready</span> (готово к запуску)</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">О задачах, которые находятся в состоянии Not Running, а также не в состояниях Blocked или Suspended, говорят, что они находятся в состоянии Ready. Они могут быть запущены и, таким образом, 'готовы к запуску' (Ready), но в настоящий момент не находятся в состоянии Running.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Полная диаграмма перехода задачи из одного состояния в другое</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рисунок 7 расширяет предыдущую упрощенную диаграмму состояний, чтобы показать все подсостояния Not Running, описанные в этой секции. Задачи, создаваемые в недавних примерах, не использовали состояния Blocked или Suspended и переходили только между состояниями Ready и Running - как показано толстыми стрелками на рисунке 7.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image14531.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 7. Полная машина состояний задачи.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Пример 4. Использование состояния Blocked для создания задержки</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Все задачи, создаваемые в недавних примерах, были 'периодическими' - они делали задержку на некоторый период, печатали свою строку, генерировали задержку снова, снова печатали строку, и так далее по кругу. Задержка генерировалась очень грубым методом с использованием пустого цикла - задача просто опрашивала значение инкрементируемой переменной цикла на достижение им фиксированного значения. В примере 3 хорошо виден недостаток такого метода. При прохождении пустого цикла задача остается в состоянии Ready, впустую отнимая полезное процессорное время от других задач.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Имеются также некоторые другие недостатки любой формы опроса (polling), заключающиеся не только в неэффективности. Во время опроса задача не делает действительно полезной работы, однако использует при этом процессорное время по максимуму. В примере 4 такое поведение исправлено путем замены опроса в пустом цикле вызовом API функции vTaskDelay(), прототип которой показан ниже. Новое определение задачи показано в листинге 12.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функция vTaskDelay() помещает вызывавшую её задачу в состояние Blocked на фиксированное количество тиков прерываний. Находясь в состоянии Blocked, задача не использует процессорное время, поэтому процессор загружен только полезной работой.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Прототип API функции vTaskDelay():</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTaskDelay( portTickType xTicksToDelay );</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">xTicksToDelay</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Количество тиков прерываний, в течение которых вызывающая задача должна оставаться в состоянии Blocked перед переходом обратно в состояние Ready.<br />Например, если задача сделала вызов vTaskDelay( 100 ), а счетчик тиков (системная переменная FreeRTOS) при этом был равен 10000, то задача немедленно войдет в состояние Blocked и останется в нем до тех пор, пока счетчик тиков не достигнет 10100.<br />Константа portTICK_RATE_MS может использоваться для преобразования миллисекунд в тики.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 12. Исходный код примера задачи после того, как пустой цикл был заменен на вызов vTaskDelay().</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTaskFunction( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTaskName;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Строка для вывода на печать, переданная через параметр. Здесь</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     параметр преобразуется в указатель на строку. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  pcTaskName = ( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> * ) pvParameters;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Как и большинство других задач, эта задача реализована как бесконечный цикл. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Печать имени этой задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( pcTaskName );<br /><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задержка на некоторый период времени. Эта задержка создается благодаря</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        использованию вызова vTaskDelay(), которым задача помещается в состояние</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        Blocked до истечения периода задержки. Период задержки указывается в 'тиках',</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        но можно использовать константу portTICK_RATE_MS для преобразования </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        (более удобной для пользователя) величины миллисекунд в тики</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">.<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        В нашем случае указан период 250 миллисекунд. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vTaskDelay( 250 / portTICK_RATE_MS );<br />  }<br />} </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Несмотря на то, что на этот раз обе задачи также были созданы с разными приоритетами, они теперь обе могут запускаться. Вывод примера 4 показан на рисунке 8, что подтверждает такое ожидаемое поведение.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image12429.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 8. Вывод, который производится при выполнении примера 4.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Последовательность выполнения, показанная на рисунке 9, объясняет, почему обе задачи теперь работают, несмотря на то, что они созданы с разными приоритетами. Для упрощения выполнение самого ядра на рисунке не показано.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задача ожидания (idle task) всегда создается автоматически, когда запускается шедулер, чем обеспечивается выполнение всегда как минимум одной задачи, которая всегда может быть запущена (т. е. найдется всегда как минимум одна задача, находящаяся в состоянии Ready). В секции главы 1.7 задача Idle Task описывается более подробно.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image12760.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 9. Последовательность выполнения, когда задачи используют vTaskDelay() вместо пустого цикла.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Изменена только реализация наших двух задач, их функциональность не поменялась. Сравнение рисунков 9 и 4 показывает, что эта функциональность достигнута более эффективным способом.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рисунок 4 показывает диаграмму выполнения, когда задачи используют пустой цикл для создания задержки - из за этого они всегда могут быть запущены, и используют процессорное время впустую. Рисунок 9 показывает диаграмму выполнения, когда задачи входят в состояние Blocked на весь период задержки, поэтому процессорное время используется только для действительно необходимой работы (для этого примера - простой вывод сообщения на печать в экран консоли).</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В сценарии на рисунке 9 каждый раз задачи покидают состояние Blocked и работают только в части периода тика, перед тем как снова войти в состояние Blocked. Почти все процессорное время оказывается свободным - нет задач приложения, которые могут запуститься (нет задач приложения в состоянии Ready), и нет задач, чтобы шедулер их выбрал для входа в состояние Running. Поэтому будет запущена задача Idle Task. Время, в котором работает задача Idle Task, дает возможность измерить запас процессорного времени в системе.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">API функция <span style=" font-weight:600;">vTaskDelayUntil() </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функция vTaskDelayUntil() работает аналогично vTaskDelay(). Как было продемонстрировано, параметр функции vTaskDelay() указывает количество тиков прерываний, которые должны произойти между вызовом из задачи vTaskDelay() и моментом времени, когда та же самая задача выйдет снова из состояния Blocked. Величина времени, в течение которого задача остается заблокированной, указывается в параметре vTaskDelay(), но реальное время, в которое задача покинет заблокированное состояние, отсчитывается относительно времени, когда был произведен вызов vTaskDelay(). Вместо этого в параметре функции vTaskDelayUntil() указывается явное значение счетчика тиков, на котором вызывающая эту функцию задача должна перейти из состояние Blocked в состояние Ready. API функция vTaskDelayUntil() должна использоваться, когда требуется фиксированный период выполнения задачи (например, Вы хотите, чтобы задача выполнялась периодически с фиксированной частотой). Так как время разблокировки вызывающей задачи является абсолютным (в отличие от относительного, отсчитываемого от вызова функции, как в случае с vTaskDelay()).</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTaskDelayUntil( portTickType * pxPreviousWakeTime,<br />                      portTickType xTimeIncrement );</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0">
<tr>
<td bgcolor="#0000ff">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#ffffff;">Имя параметра</span></p></td>
<td bgcolor="#0000ff">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#ffffff;">Описание</span></p></td></tr>
<tr>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" background-color:#ccffff;"> pxPreviousWakeTime</span></p></td>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" background-color:#ccffff;">Этот параметр поименован так из предположения, что vTaskDelayUntil() выполняется периодически и с фиксированной частотой. В этом случае переменная, на которую указывает pxPreviousWakeTime, удерживает время, в которое задача покинула состояние Blocked (т. е. время, когда задача 'проснулась'). Это время используется как точка отсчета для вычисления момента времени, когда произойдет следующий выход из состояния Blocked.</span><br /><br />Переменная, на которую указывает pxPreviousWakeTime, обновляется автоматически внутри функции vTaskDelayUntil(), и она обычно не должна быть модифицирована кодом приложения за исключением первоначальной инициализации. В листинге 14 показано, как это нужно делать.</p></td></tr>
<tr>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" background-color:#ccffff;"> xTimeIncrement</span></p></td>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" background-color:#ccffff;">Этот параметр также поименован в предположении, что функция vTaskDelayUntil() используется для реализации, которая выполняется периодически и с фиксированной частотой - частота устанавливается значением параметра xTimeIncrement. Величина xTimeIncrement указывается в 'тиках'. Можно использовать константу portTICK_RATE_MS для преобразования миллисекунд в тики.</span></p></td></tr></table>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Пример 5. Преобразование задач из примера 4 для использования функции vTaskDelayUntil()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Две задачи, созданные в примере 4, являются периодическими, но использование vTaskDelay() не гарантирует, что частота запуска задачи будет фиксированной, так как время, в которое задача покидает состояние Blocked, отсчитывается относительно момента вызова vTaskDelay(). Преобразование задач на использование vTaskDelayUntil() вместо vTaskDelay() решит эту потенциальную проблему.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 14. Реализация примера задачи с использованием vTaskDelayUntil().</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTaskFunction( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTaskName;<br />portTickType xLastWakeTime;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Строка для вывода на печать, переданная через параметр. Здесь</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     параметр преобразуется в указатель на строку. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  pcTaskName = ( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> * ) pvParameters;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Переменная xLastWakeTime нуждается в инициализации текущим</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     значением счетчика тиков. Имейте в виду, переменная записывается</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     явно только в этот момент. Затем xLastWakeTime обновляется </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     автоматически внутри функции vTaskDelayUntil(). */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xLastWakeTime = xTaskGetTickCount();<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Как и большинство других задач, эта задача реализована как бесконечный цикл. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Печать имени этой задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( pcTaskName );<br /><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Эта задача должна выполняться точно каждые 250 миллисекунд. Как и</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        в функции vTaskDelay(), время измеряется в тиках, и константа</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        portTICK_RATE_MS используется для преобразования миллисекунд в тики.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        Переменная xLastWakeTime автоматически обновляется внутри функции</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        vTaskDelayUntil(), и нигде явно в коде задачи переменная xLastWakeTime</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        не обновляется. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vTaskDelayUntil( &amp;xLastWakeTime, ( 250 / portTICK_RATE_MS ) );<br />  }<br />} </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вывод, производимый примером 5, абсолютно совпадает с выводом из примера 4, показанным на рисунке 8.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Пример 6. Комбинирование блокирующихся и не блокирующихся задач</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Предыдущие примеры рассматривали поведение обоих задач с опросом и задач с блокированием в изоляции друг от друга. Этот пример закрепляет установленное ожидаемое поведение системы путем демонстрации последовательности выполнения, где две схемы поведения комбинируются следующим образом:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">две задачи создаются с приоритетом 1. Они ничего не делают кроме того, что постоянно выводят на печать строку. Эти задачи не делают никаких вызовов API, которые вводят их в состояние Blocked, поэтому они всегда находятся в состоянии либо Ready, либо Running. Задачи с таким поведением называют задачами 'с непрерывной обработкой' ('continuous processing') - это задачи, которые всегда должны что-то делать, выполняя обычно не такую тривиальную работу, как в нашем примере. Исходный код задач с непрерывной обработкой показан в листинге 15.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">третья задача создается с приоритетом 2, который выше приоритета двух других задач. Третья задача также просто выводит строку на печать, однако она периодически использует вызовы API функции vTaskDelayUntil(), чтобы поместить саму себя в состояние Blocked между каждым повтором печати. Исходный код этой периодической задачи показан в листинге 16.</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 15. Задача с непрерывной обработкой, используемая в примере 6.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vContinuousProcessingTask( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTaskName;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Строка для вывода на печать, переданная через параметр. Здесь</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     параметр преобразуется в указатель на строку. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  pcTaskName = ( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> * ) pvParameters;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Как и большинство других задач, эта задача реализована как бесконечный цикл. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Печать имени этой задачи, что постоянно повторяется без блокирования</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        или задержки. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( pcTaskName );<br />  }<br />} </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 16. Периодически выполняемая задача, используемая в примере 6.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vPeriodicTask( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br />portTickType xLastWakeTime;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Переменная xLastWakeTime нуждается в инициализации текущим</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     значением счетчика тиков. Имейте в виду, переменная записывается</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     явно только в этот момент. Затем xLastWakeTime обновляется </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     автоматически внутри функции vTaskDelayUntil(). */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xLastWakeTime = xTaskGetTickCount();<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Как и большинство других задач, эта задача реализована как бесконечный цикл. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Печать имени этой задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Periodic task is running\r\n&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> );<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Эта задача должна выполняться точно через каждые 10 миллисекунд. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vTaskDelayUntil( &amp;xLastWakeTime, ( 10 / portTICK_RATE_MS ) );<br />  }<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На рисунке 11 показан вывод в консоль примера 6, с разъяснением наблюдаемого поведения, которое дает последовательность выполнения, показанная на рисунке 12.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image13719.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 11. Вывод, который производит при выполнении пример 6.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image9952.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 12. Диаграмма выполнения примера 6.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">1.7. Специальная Задача Ожидания (IDLE TASK) и хук задачи ожидания (IDLE TASK HOOK)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задачи, созданные в примере 4, почти все время находятся в состоянии Blocked. В этом состоянии они не могут быть запущены и не могут быть выбраны шедулером. Любой процессор всегда должен что-то делать, поэтому как минимум одна задача должна быть в состоянии войти в режим Running. Чтобы обеспечить это условие, при вызове vTaskStartScheduler() шедулер автоматически создает специальную задачу ожидания Idle Task. Задача Idle Task почти ничего не делает, кроме того как находится в цикле - так что все другие задачи, наподобие задач из наших примеров, всегда могут быть запущены.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Запуск Idle Task с самым низким приоритетом (приоритетом 0) дает гарантию, что Idle Task немедленно выйдет из состояния Running, как только любая задача (которая конечно имеет более высокий приоритет, чем Idle Task) войдет в состояние Ready. Это можно увидеть на рисунке 9, где Idle Task немедленно приостанавливается, чтобы позволить задаче 2 выполниться, как только задача 2 выйдет из состояния Blocked. Говорят, что задача 2 <span style=" font-weight:600;">ВЫТЕСНЯЕТ</span> задачу Idle Task (Task 2 <span style=" font-weight:600;">pre-empted</span> Idle Task). Вытеснение происходит автоматически, без необходимости что-то знать о вытесняющей задаче.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Функции IDLE TASK HOOK</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В задачу Idle Task можно добавить функционал приложения пользователя. Это делается через функцию хука Idle (иначе её называют callback-функцией) - она автоматически будет вызываться изнутри Idle Task, каждый раз в цикле ожидания.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Можно использовать Idle Task hook следующим образом:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Выполнение низкоприоритетных задач в фоновом режиме, или продолжительные обработки данных.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Измерение свободного процессорного времени (т. е. загруженности процессора) - задача Idle Task будет работать только тогда, когда все другие задачи не выполняют свою работу (им нечего делать), поэтому измерение процессорного времени, выделенного на Idle Task, явно показывает, сколько процессорного времени имеется в запасе.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перевод процессора в режим пониженного энергопотребления - предоставление автоматического метода сохранения энергии, когда приложением не выполняется полезная обработка данных.</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Ограничения, связанные с использованием функций Idle Task hook</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функции Idle Task hook должны удовлетворять следующим правилам:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">1. Они никогда не должны делать попыток приостановки (переход в состояние Suspended) или блокировки (переход в состояние Blocked). Задача Idle Task будет выполняться только тогда, когда другим задачам нечего делать (за исключением тех случаев, когда задачи приложения имеют тот же приоритет, что и Idle Task). Поэтому блокировка Idle Task приведет к тому, что не будет ни одной задачи, которая могла бы войти в состояние Running!</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2. Если приложение использует вызовы API функции vTaskDelete(), то функция Idle Task hook должна всегда быть завершена в течение подходящего периода времени. Причина этого в том, что задача Idle Task отвечает за очистку ресурсов ядра после удаления задачи. Если управление потоком выполнения Idle Task остается постоянно в коде Idle Task hook, то тогда очистка не может быть выполнена.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функции Idle Task hook должны иметь следующие имя и прототип:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vApplicationIdleHook( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> );</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Пример 7. Определение функции Idle Task hook</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Использование блокирующих вызовов API функции vTaskDelay() в примере 4 создает некоторый интервал времени ожидания - в это время выполняется задача Idle Task, так как обе задачи приложения находятся в состоянии Blocked. Пример 7 использует это время ожидания путем добавления функции Idle Task hook, исходный код которой показан в листинге 18.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 18. Очень простой пример функции Idle Task hook.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Определение переменной, которая будет инкрементирована функцией хука. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />unsigned </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">long</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> ulIdleCycleCount = 0UL;<br /><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Функции хука Idle ДОЛЖНЫ называться vApplicationIdleHook(), не принимать никаких параметров, и возвращать void. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vApplicationIdleHook( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> )<br />{<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Эта функция хука ничего не делает, кроме инкрементирования счетчика. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  ulIdleCycleCount++;<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы функция Idle Task hook vApplicationIdleHook вызывалась, в файле FreeRTOSConfig.h нужно установить в 1 макрос configUSE_IDLE_HOOK.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функция, которая реализует созданные задачи, получила незначительные изменения, чтобы выводить на печать значение ulIdleCycleCount, как показано в листинге 19.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 19. Исходный код для примера задачи, которая теперь печатает значение переменной ulIdleCycleCount.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTaskFunction( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pcTaskName;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Строка для вывода на печать, переданная через параметр. Здесь</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     параметр преобразуется в указатель на строку. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  pcTaskName = ( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">char</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> * ) pvParameters;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Как и большинство других задач, эта задача реализована как бесконечный цикл. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Печать имени этой задачи и количества инкрементов переменной</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        ulIdleCycleCount. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintStringAndNumber( pcTaskName, ulIdleCycleCount );<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задержка на 250 миллисекунд. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vTaskDelay( 250 / portTICK_RATE_MS );<br />  }<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вывод, производимый примером 7, показан на рисунке ниже и на нем видно, что функция Idle Task hook вызывается (очень приблизительно) 4.5 миллиона раз между каждой итерацией задач приложения.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image20328.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">1.8. Изменение приоритета задачи</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">API функция </span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#000000; background-color:#ffffff;">vTaskPrioritySet()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Для изменения приоритета любой задачи после старта шедулера может быть использована API функция vTaskPrioritySet().</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff; background-color:#ffffff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;"> vTaskPrioritySet( xTaskHandle pxTask, unsigned portBASE_TYPE uxNewPriority );</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0" bgcolor="#ffffff">
<tr>
<td bgcolor="#0000ff">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#ffffff;">Имя параметра</span></p></td>
<td bgcolor="#0000ff">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#ffffff;">Описание</span></p></td></tr>
<tr>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ccffff;"> pxTask</span></p></td>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ccffff;">Хендл задачи (субъект задачи), у которой будет изменен приоритет - см. параметр pxCreatedTask функции API xTaskCreate() для более подробной информации по получению хендлов для задач. Задача может изменить собственный приоритет путем передачи NULL вместо действительного хендла задачи.</span></p></td></tr>
<tr>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ccffff;"> uxNewPriority</span></p></td>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ccffff;">Приоритет, в который будет установлен субъект задачи. Значение, переданное в этом параметре, автоматически ограничивается величиной максимально доступного приоритета (configMAX_PRIORITIES – 1), где configMAX_PRIORITIES опция времени компиляции, установленная в заголовочном файле FreeRTOSConfig.h.</span></p></td></tr></table>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">API функция </span><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#000000; background-color:#ffffff;">uxTaskPriorityGet()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Для получения текущего приоритета задачи может быть использована API функция uxTaskPriorityGet().</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#000000; background-color:#ffffff;">unsigned portBASE_TYPE uxTaskPriorityGet( xTaskHandle pxTask );</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="2" cellpadding="0" bgcolor="#ffffff">
<tr>
<td bgcolor="#0000ff">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#ffffff;">Имя параметра<br />/<br />возвращаемое значение</span></p></td>
<td bgcolor="#0000ff">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#ffffff;">Описание</span></p></td></tr>
<tr>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ccffff;"> pxTask</span></p></td>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ccffff;">Хендл задачи, приоритет которой запрашивается - см. параметр pxCreatedTask функции API xTaskCreate() для более подробной информации по получению хендлов для задач. Задача может запросить собственный приоритет путем передачи NULL вместо действительного хендла задачи.</span></p></td></tr>
<tr>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ccffff;">Возвращаемое значение</span></p></td>
<td bgcolor="#ccffff">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ccffff;">Значение запрошенного приоритета, который в настоящий момент назначен задаче.</span></p></td></tr></table>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; font-weight:600; color:#000000; background-color:#ffffff;">Пример 8. Изменение приоритета задачи</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">В качестве задачи для входа в состояние Running шедулер всегда выбирает задачу в состоянии Ready, которая имеет наивысший приоритет. Пример 8 демонстрирует это, используя API функцию vTaskPrioritySet() для изменения приоритета одной задачи относительно другой.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Две задачи создаются с разными приоритетами. Никакая из задач не делает вызовов API для входа в состояние Blocked, так что обе задачи всегда находятся либо в состоянии Ready, либо Running - так что задача с более высоким приоритетом (относительно другой задачи) будет всегда выбираться шедулером для входа в состояние Running.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Пример 8 работает следующим образом:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:11px;">Задача 1 (см. листинг 22) создается с самым высоким приоритетом - это гарантирует, что она запустится первой. Задача 1 печатает набор строк перед тем, как повысит приоритет задачи 2 (см. листинг 23) выше собственного приоритета.</span></li>
<li style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:11px;">Задача 2 запускается на выполнение (входит в режим Running), как только она получит более высокий относительный приоритет. В любой момент времени в состоянии Running может находиться только одна задача, поэтому когда задача 2 находится в состоянии Running, задача 1 находится в состоянии Ready.</span></li>
<li style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:11px;">Задача 2 выводит на печать сообщение перед тем как установить свой приоритет в значение ниже приоритета задачи 1.</span></li>
<li style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:11px;">Задача 2 устанавливает свой приоритет обратно вниз, что означает получение задачей 1 снова наивысшего приоритета. Поэтому задача 1 снова входит в состояние Running, принуждая задачу 2 вернуться в состояние Ready.</span></li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 22. Реализация задачи 1 в примере 8.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTask1( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br />unsigned portBASE_TYPE uxPriority;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Эта задача 1 всегда стартует первой, перед задачей 2, так как она создана</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     с более высоким приоритетом. Ни задача 1, ни задача 2 никогда не блокируются</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     (не находятся в состоянии Blocked), они всегда находятся либо в состоянии</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     Running, либо в состоянии Ready.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     Запрос приоритета, при котором эта задача работает. Передача NULL в параметре</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     означает &quot;выдайте мой приоритет&quot;. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  uxPriority = uxTaskPriorityGet( NULL );<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Печать имени этой задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task1 is running\r\n&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> );<br /><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Установка приоритета задачи 2 выше приоритета задачи 1 приведет к тому,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        что задача 2 немедленно запустится на выполнение (так как задача 2</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        будет иметь самый высокий приоритет из двух созданных задач). Обратите</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        внимание, что используется хендл задачи 2 (xTask2Handle) в вызове</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        vTaskPrioritySet(). Листинг 24 показывает, как этот хендл был получен. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;About to raise the Task2 priority\r\n&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> );<br />     vTaskPrioritySet( xTask2Handle, ( uxPriority + 1 ) );<br /><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задача 1 запустится только тогда, когда у неё приоритет станет выше,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        чем у задачи 2. Таким образом, при достижении потоком выполнения этой</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        точки кода задача 2 уже выполнилась и понизила свой приоритет обратно,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        так что он снова стал ниже приоритета этой задачи 1. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  }<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">Каждая задача может и запросить, и установить собственный приоритет без использования действительного хендла задачи - заместо него просто используется NULL. Хендл задачи нужен только тогда, когда задача хочет запросить или изменить приоритет другой задачи, как например когда задача 1 меняет приоритет задачи 2. Чтобы позволить задаче 1 сделать это, полученный хендл задачи 2 сохраняется, когда создается задача 2 - как пояснено в комментариях листинга 24.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 23. Реализация задачи 2 в примере 8.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Определение переменной для сохранения хендла задачи 2. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />xTaskHandle xTask2Handle;<br /><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">int</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> main( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> )<br />{<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Создание задачи 1 с приоритетом 2. Параметры задачи не используются и </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     установлены в NULL. Хендл задачи также не используется и тоже</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     установлен в NULL. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xTaskCreate( vTask1, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 1&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">, 1000, NULL, 2, NULL );<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задача 1 создана с приоритетом 2 _______^. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Создание задачи 2 с приоритетом 1, который меньше приоритета задачи 1.</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     Снова параметр задачи не используется и установлен в NULL, но на этот</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     раз нужен хендл задачи, и в качестве последнего параметра передается</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     адрес переменной xTask2Handle. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xTaskCreate( vTask2, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">, 1000, NULL, 1,       &amp;xTask2Handle );<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* В последнем параметре будет сохранен хендл задачи ^^^^^^^^^^^^^ */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Запуск шедулера для начала выполнения задач. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  vTaskStartScheduler();<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Если все хорошо, то управление в main() никогда не дойдет до этой точки,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     и теперь шедулер будет управлять задачами. Если main() довела управление до </span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     этого места, то это может означать, что не хватает памяти кучи (heap)</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     для создания специальной задачи ожидания (idle task, см. раздел 1.7).</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     Часть 5 предоставляет больше информации по управлению памятью. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; );<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000; background-color:#ffffff;">На рисунке ниже показана последовательность, в которой выполняются задачи примера 8, в результате чего получается вывод, показанный далее.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image516803545.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23946.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">1.9. Удаление задачи</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">API функция <span style=" font-weight:600;">vTaskDelete()</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задача может использовать API функцию vTaskDelete() для удаления самой себя или любой другой задачи.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Удаленные задачи более не существуют, и не могут снова войти в состояние Running.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда задача удаляется, специальная задача Idle Task отвечает за освобождение памяти, которая была ранее выделена для удаленной задачи. Поэтому важно, чтобы приложения, в которых используется API функция vTaskDelete(), не отнимали полностью все процессорное время у задачи Idle Task.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Внимание - при удалении задачи автоматически освобождается только та память, которая была неявно выделена ядром для задачи. Любая память или другие ресурсы, которые были выделены в реализации самой задачи, должны быть освобождены специально в коде приложения.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTaskDelete( xTaskHandle pxTaskToDelete );</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">pxTaskToDelete</span> - Хендл задачи, которая должна быть удалена (субъект задачи) - см. параметр pxCreatedTask функции API xTaskCreate() для более подробной информации по получению хендлов для задач. Задача может удалить саму себя путем передачи NULL вместо действительного хендла задачи.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Пример 9. Удаление задач</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Этот очень простой пример делает следующее:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задача 1 создается функцией main() с приоритетом 1. Когда задача 1 запускается, она создает задачу 2 с приоритетом 2. Теперь задача 2 имеет наивысший приоритет, так что она начнет свое выполнение немедленно. Исходный код функции main() показан в листинге 26, а исходный код задачи 1 показан в листинге 27.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Задача 2 ничего не делает, просто удаляет саму себя. Она могла бы удалить себя простой передачей NULL в качестве параметра функции vTaskDelete(), однако в целях полной демонстрации использует вместо NULL собственный хендл задачи. Исходный код задачи 2 показан в листинге 28.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда задача 2 удалена, задача 1 снова получит наивысший приоритет среди всех имеющихся задач (так как она вообще осталась одна), и поэтому продолжит выполнение - в этот момент она делает вызов vTaskDelay() для блокировки себя (войдет в состояние Blocked) на короткий интервал времени.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда задача 1 находится в состоянии Blocked, запустится Idle Task и освободит память, которая была ранее выделена для удаленной теперь задачи 2.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда задача 1 покидает состояние Blocked, то она снова войдет в режим Ready с наивысшим приоритетом, и вытеснит (pre-empt) задачу Idle Task. Когда задача 1 войдет в состояние Running, она просто создает задачу 2 заново, и так далее - весь процесс повторяется снова и снова.</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 26. Реализация функции main() для примера 9.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">int</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> main( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> )<br />{<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Создание первой задачи 1 с приоритетом 1. Параметр задачи не используется</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     и поэтому установлен в NULL. Хендл задачи также не используется и также</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     установлен в NULL. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  xTaskCreate( vTask1, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 1&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">, 1000, NULL, 1, NULL );<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задача создана с приоритетом 1 _________^. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Запуск шедулера, после чего задачи начнут свое выполнение. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  vTaskStartScheduler();<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* После запуска шедулера управление потоком main() никогда не достигнет</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     этого места. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; );<br />} </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 27. Реализация задачи 1 для примера 9.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTask1( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">const</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> portTickType xDelay100ms = 100 / portTICK_RATE_MS;<br /><br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">for</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">( ;; )<br />  {<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Печать имени этой задачи. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vPrintString( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task1 is running\r\n&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> );<br /><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Создание задачи 2 с более высоким приоритетом. Снова параметр задачи</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        не используется и установлен в NULL, однако на этот раз нужен хендл</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        задачи, и передается адрес переменной xTask2Handle в качестве</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        последнего параметра. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     xTaskCreate( vTask2, </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task 2&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;">, 1000, NULL, 2, &amp;xTask2Handle );<br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Последний параметр - хендл задачи _________^^^^^^^^^^^^^ */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /><br />     </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* У задачи 2 самый высокий приоритет, так что если управление потоком</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        выполнения задачи 1 достигло этой точки, то задача 2 уже выполнилась</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">        и удалила саму себя. Далее производится задержка на 100 миллисекунд. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />     vTaskDelay( xDelay100ms );<br />  }<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Листинг 28. Реализация задачи 2 для примера 9.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> vTask2( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#0000ff;">void</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> *pvParameters )<br />{<br />  </span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">/* Задача ничего не делает, кроме того как удаляет саму себя. Для этой цели</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     она вызывает vTaskDelete(), и могла бы передать в качестве параметра NULL,</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br /></span><span style=" font-family:'Courier New'; font-size:10pt; color:#008000;">     однако для полной демонстрации она передает вместо этого свой хендл. */</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"><br />  vPrintString( </span><span style=" font-family:'Courier New'; font-size:10pt; color:#a31515;">&quot;Task2 is running and about to delete itself\r\n&quot;</span><span style=" font-family:'Courier New'; font-size:10pt; color:#000000;"> );<br />  vTaskDelete( xTask2Handle );<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image22738.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image183.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рис. 17. Последовательность выполнения примера 9.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Verdana,Arial,Helvetica,sans-serif'; font-size:10pt; color:#000000;"><br /></p></body></html>