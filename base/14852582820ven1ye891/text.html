<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Georgia'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">[Правильное использование ключевого слова volatile]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Переменная должна быть декларирована как volatile всякий раз, когда возможно её неожиданное изменение. На практике это могут быть только 3 типа таких переменных:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">1.</span> Отображенные на память регистры процессора или его периферийного устройства (memory-mapped peripheral registers).<br /><span style=" font-weight:600;">2.</span> Глобальные переменные, модифицируемые в коде обработчика прерывания (interrupt service routine, ISR).<br /><span style=" font-weight:600;">3.</span> Глобальные переменные, к которым обращаются разные задачи в многопоточного приложения (обычно имеются в виду разные потоки RTOS).</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Рассмотрим подробнее каждый из этих трех случаев.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; font-weight:600;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Регистры периферийных устройств процессора. Встраиваемые системы на микроконтроллерах содержат реальное аппаратное оборудование, обычно это различные интерфейсы для обмена данными с внешним миром (UART, SPI, I2C и т. д.). Это так называемые периферийные устройства, и они содержат регистры, значение которых может асинхронно поменяться (асинхронно по отношению к выполняемому коду) в любой момент времени. Как очень простой пример, рассмотрим 8-битный регистр статуса, отображенный на адрес памяти 0x1234. Программа должна опрашивать этот регистр в ожидании, когда он станет не равным 0. Наивная и некорректная реализация будет такой: </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">uint8_t</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';"> pReg </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">uint8_t</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">) </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x1234</span><span style=" font-family:'Courier New,courier';">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; color:#888888;">// Ожидание, когда регистр станет не равным 0:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">while</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">pReg </span><span style=" font-family:'Courier New,courier'; color:#333333;">==</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">0</span><span style=" font-family:'Courier New,courier';">) { } </span><span style=" font-family:'Courier New,courier'; color:#888888;">// (в цикле ожидания могут быть и другие действия)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обычно такой код приведет к ошибке, как только Вы включите оптимизацию компилятора, когда со включенной оптимизацией будет сгенерирован примерно такой код: </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#3366ff;">   mov</span><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#996633;">ptr</span><span style=" font-family:'Courier New,courier';">, #</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x1234</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#3366ff;">   mov</span><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#996633;">a</span><span style=" font-family:'Courier New,courier';">, @</span><span style=" font-family:'Courier New,courier'; color:#996633;">ptr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#997700;">loop:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#3366ff;">bz</span><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#996633;">loop</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Причина, по которой компилятор поступил так, довольно проста: значение переменной уже было ранее прочитано в аккумулятор (в первой строке приведенного кода ассемблера), и нет никакой необходимости каждый раз заново считывать значение переменной, поскольку оно всегда с точки зрения компилятора остается неизменным. Компилятор пока что ничего не знает о том, что переменная может быть где-то изменена. Однако такой код совсем не то, что мы ожидали получить. Чтобы исправить ситуацию, изменим декларацию указателя следующим образом: </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">uint8_t</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">volatile</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';"> pReg </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">uint8_t</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">volatile</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">) </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x1234</span><span style=" font-family:'Courier New,courier';">;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New';">Теперь код ассемблера станет таким: </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">mov</span><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#996633;">ptr</span><span style=" font-family:'Courier New,courier';">, #</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x1234</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#997700;">loop:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">mov</span><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#996633;">a</span><span style=" font-family:'Courier New,courier';">, @</span><span style=" font-family:'Courier New,courier'; color:#996633;">ptr</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">bz</span><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#996633;">loop</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Требуемое поведение программы достигнуто.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Коварные проблемы склонны возникать с регистрами, у которых есть специальные свойства. Например, некоторые периферийные устройства содержат регистры, которые обнуляются простым их чтением. Дополнительное количество их чтений (или меньшее количество их чтений), отличающееся от ожидаемого, могут привести к совершенно непредсказуемым результатам.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Обработчики прерываний</span>. Обработчики прерываний (interrupt service routines, ISR) часто устанавливают переменные, которые проверяются в основном коде (работающем вне прерывания) или в коде другого прерывания. Например, ISR последовательного порта может проверять каждый принятый символ на предмет появления символа ETX (предположительно обозначающего конец сообщения). Если встретился символ ETX, то ISR может установить некий глобальный флаг. Некорректная реализация может быть следующей: </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">int</span><span style=" font-family:'Courier New,courier';"> etx_rcvd </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> FALSE;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">main</span><span style=" font-family:'Courier New,courier';">() </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    ... </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">while</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; color:#333333;">!</span><span style=" font-family:'Courier New,courier';">ext_rcvd) </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; color:#888888;">// Wait</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    } </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">interrupt </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">rx_isr</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">) </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    ... </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">if</span><span style=" font-family:'Courier New,courier';"> (ETX </span><span style=" font-family:'Courier New,courier'; color:#333333;">==</span><span style=" font-family:'Courier New,courier';"> rx_char) </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">        etx_rcvd </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> TRUE;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    } </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда оптимизация компилятора выключена (так обычно поступают при отладке), этот код может работать. Однако практически любой более-менее достойный оптимизатор &quot;поломает&quot; этот код. Проблема в том, что компилятора нет никакой информации о том, что переменная etx_rcvd может быть изменена в ISR. Пока компилятор считает так, то для него выражение !ext_rcvd всегда истина, так что цикл никогда не завершится. Следовательно, весь код после тела цикла оптимизатором может быть просто удален оптимизатором. Если Вам повезет, то компилятор сообщит об этом. Если не повезет (или Вы еще не научились обращать внимание на сообщения компилятора), то работа кода будет нарушена. Естественно, вина сразу будет возложена на &quot;паршивый оптимизатор&quot;.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Решением в этой ситуации будет объявить переменную etx_rcvd как volatile. Тогда все Ваши проблемы (или по крайней мере проблемы, связанные с этим случаем) исчезнут.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Многопоточные приложения</span>. Несмотря на наличие очередей (queues), каналов (pipes), и других механизмов обмена в многопоточном окружении (RTOS), все равно обычной практикой остается обмен информацией между двумя потоками с помощью общей памяти (глобальной переменной). Даже когда Вы добавите вытесняющий планировщик в свой код, у компилятора все равно нет никаких предположений, что сработает переключение контекста, и что это может произойти. В этом случае, когда другая задача модифицировала общую глобальную переменную, может произойти то же самое, как и с обработчиком прерывания, что уже обсуждалось выше. Как и в предыдущем примере, общая переменная должна быть объявлена как volatile. Например, здесь могут быть проблемы в коде при доступе к общей переменной cntr из разных задач: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">int</span><span style=" font-family:'Courier New,courier';"> cntr;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">task1</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">) </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    cntr </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">0</span><span style=" font-family:'Courier New,courier';">; </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">while</span><span style=" font-family:'Courier New,courier';"> (cntr </span><span style=" font-family:'Courier New,courier'; color:#333333;">==</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">0</span><span style=" font-family:'Courier New,courier';">) </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">        sleep(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">1</span><span style=" font-family:'Courier New,courier';">);</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    } </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">task2</span><span style=" font-family:'Courier New,courier';">(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">void</span><span style=" font-family:'Courier New,courier';">) </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">{</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    cntr</span><span style=" font-family:'Courier New,courier'; color:#333333;">++</span><span style=" font-family:'Courier New,courier';">; </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    sleep(</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">10</span><span style=" font-family:'Courier New,courier';">); </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">    ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Этот код скорее всего не будет работать, когда оптимизация будет разрешена. Декларирование cntr как volatile будет правильным путем решения проблемы.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">[<span style=" font-weight:600;">Дополнительные замечания</span>]</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Некоторые компиляторы позволяют Вам неявно декларировать все переменные как volatile. Не поддавайтесь на это искушение, потому что оно по сути отучает думать (как впрочем, и отключение оптимизации). Это также потенциально приводит к менее оптимизированному коду.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если Вам дали для исправления некий бажный код, тупо выполните операцию grep по текстам исходного кода в поиске ключевого слова volatile. Если вывод grep окажется пустым, то приведенные здесь примеры дадут хорошую стартовую точку для поиска проблем.</p></body></html>