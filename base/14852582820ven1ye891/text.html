<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Courier New'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia'; font-weight:600;">[Правильное использование ключевого слова volatile]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia';">Переменная должна быть декларирована как volatile всякий раз, когда возможно её неожиданное изменение. На практике это могут быть только 3 типа таких переменных:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia'; font-weight:600;">1.</span><span style=" font-family:'Georgia';"> Отображенные на память регистры процессора или его периферийного устройства (memory-mapped peripheral registers).<br /></span><span style=" font-family:'Georgia'; font-weight:600;">2.</span><span style=" font-family:'Georgia';"> Глобальные переменные, модифицируемые в коде обработчика прерывания (interrupt service routine, ISR).<br /></span><span style=" font-family:'Georgia'; font-weight:600;">3.</span><span style=" font-family:'Georgia';"> Глобальные переменные, к которым обращаются разные задачи в многопоточного приложения (обычно имеются в виду разные потоки RTOS).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia'; font-weight:600;">Рассмотрим подробнее каждый из этих трех случаев.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-weight:600;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Georgia';">Регистры периферийных устройств процессора. Встраиваемые системы на микроконтроллерах содержат реальное аппаратное оборудование, обычно это различные интерфейсы для обмена данными с внешним миром (UART, SPI, I2C и т. д.). Это так называемые периферийные устройства, и они содержат регистры, значение которых может асинхронно поменяться (асинхронно по отношению к выполняемому коду) в любой момент времени. Как очень простой пример, рассмотрим 8-битный регистр статуса, отображенный на адрес памяти 0x1234. Программа должна опрашивать этот регистр в ожидании, когда он станет не равным 0. Наивная и некорректная реализация будет такой: </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Georgia';"><br /></p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">uint8_t</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';"> pReg </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">uint8_t</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">) </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x1234</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';"> </span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; color:#888888;">// Ожидание, когда регистр станет не равным 0:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">while</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">pReg </span><span style=" font-family:'Courier New,courier'; color:#333333;">==</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0000dd;">0</span><span style=" font-family:'Courier New,courier';">) { } </span><span style=" font-family:'Courier New,courier'; color:#888888;">// (в цикле ожидания могут быть и другие действия)</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обычно такой код приведет к ошибке, как только Вы включите оптимизацию компилятора, когда со включенной оптимизацией будет сгенерирован примерно такой код: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#3366ff;">   mov</span><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#996633;">ptr</span><span style=" font-family:'Courier New,courier';">, #</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x1234</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#3366ff;">   mov</span><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#996633;">a</span><span style=" font-family:'Courier New,courier';">, @</span><span style=" font-family:'Courier New,courier'; color:#996633;">ptr</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#997700;">loop:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#3366ff;">bz</span><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#996633;">loop</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Причина, по которой компилятор поступил так, довольно проста: значение переменной уже было ранее прочитано в аккумулятор (в первой строке приведенного кода ассемблера), и нет никакой необходимости каждый раз заново считывать значение переменной, поскольку оно всегда с точки зрения компилятора остается неизменным. Компилятор пока что ничего не знает о том, что переменная может быть где-то изменена. Однако такой код совсем не то, что мы ожидали получить. Чтобы исправить ситуацию, изменим декларацию указателя следующим образом: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">uint8_t</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">volatile</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';"> pReg </span><span style=" font-family:'Courier New,courier'; color:#333333;">=</span><span style=" font-family:'Courier New,courier';"> (</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#333399;">uint8_t</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#008800;">volatile</span><span style=" font-family:'Courier New,courier';"> </span><span style=" font-family:'Courier New,courier'; color:#333333;">*</span><span style=" font-family:'Courier New,courier';">) </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x1234</span><span style=" font-family:'Courier New,courier';">;</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь код ассемблера станет таким: </p>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%; background-color:#ffffff;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">mov</span><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#996633;">ptr</span><span style=" font-family:'Courier New,courier';">, #</span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#005588;">0x1234</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier'; font-weight:600; color:#997700;">loop:</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">mov</span><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; color:#996633;">a</span><span style=" font-family:'Courier New,courier';">, @</span><span style=" font-family:'Courier New,courier'; color:#996633;">ptr</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:125%;"><span style=" font-family:'Courier New,courier';">   </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#0066bb;">bz</span><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; color:#996633;">loop</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Требуемое поведение программы достигнуто.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Коварные проблемы склонны возникать с регистрами, у которых есть специальные свойства. Например, некоторые периферийные устройства содержат регистры, которые обнуляются простым их чтением. Дополнительное количество их чтений (или меньшее количество их чтений), отличающееся от ожидаемого, могут привести к совершенно непредсказуемым результатам.</p></body></html>